<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Voice Room (Serverless)</title>
    <!-- –ü–æ–¥–∫–ª—é—á–∞–µ–º –±–∏–±–ª–∏–æ—Ç–µ–∫—É Trystero –¥–ª—è —Å–≤—è–∑–∏ –±–µ–∑ —Å–µ—Ä–≤–µ—Ä–∞ -->
    <script src="https://unpkg.com/trystero/dist/trystero-torrent.min.js"></script>
    
    <style>
        :root { --bg: #36393f; --dark: #2f3136; --darker: #202225; --accent: #5865f2; --text: #dcddde; --red: #ed4245; }
        * { box-sizing: border-box; }
        body { margin: 0; background: var(--bg); color: var(--text); font-family: 'Segoe UI', sans-serif; height: 100vh; display: flex; flex-direction: column; overflow: hidden; }
        
        /* –õ–æ–≥–∏–Ω */
        #login-screen { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: var(--darker); display: flex; justify-content: center; align-items: center; z-index: 100; backdrop-filter: blur(5px); }
        .login-box { background: var(--dark); padding: 25px; border-radius: 12px; width: 90%; max-width: 320px; display: flex; flex-direction: column; gap: 15px; box-shadow: 0 8px 24px rgba(0,0,0,0.5); }
        .login-box h2 { text-align: center; margin: 0; color: white; }
        input { background: var(--darker); border: 1px solid #222; padding: 12px; color: white; border-radius: 6px; outline: none; font-size: 16px; transition: 0.2s; }
        input:focus { border-color: var(--accent); }
        button.btn-primary { background: var(--accent); color: white; border: none; padding: 12px; border-radius: 6px; cursor: pointer; font-weight: bold; font-size: 16px; transition: 0.2s; }
        button.btn-primary:active { transform: scale(0.98); }
        
        /* –•–µ–¥–µ—Ä */
        header { background: var(--darker); padding: 15px; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #222; box-shadow: 0 1px 5px rgba(0,0,0,0.2); }
        .status-badge { font-size: 12px; background: #222; padding: 4px 8px; border-radius: 10px; color: #aaa; }
        .status-badge.online { color: #43b581; background: rgba(67, 181, 129, 0.1); }

        /* –°–µ—Ç–∫–∞ —é–∑–µ—Ä–æ–≤ */
        #users-grid { flex: 1; padding: 20px; display: grid; grid-template-columns: repeat(auto-fill, minmax(110px, 1fr)); gap: 15px; align-content: start; overflow-y: auto; }
        
        /* –ö–∞—Ä—Ç–æ—á–∫–∞ */
        .user-card { background: var(--dark); border-radius: 12px; padding: 15px; display: flex; flex-direction: column; align-items: center; position: relative; transition: 0.2s; animation: popIn 0.3s ease; }
        @keyframes popIn { from { opacity: 0; transform: scale(0.9); } to { opacity: 1; transform: scale(1); } }
        
        .avatar-wrapper { position: relative; width: 70px; height: 70px; }
        .avatar { width: 100%; height: 100%; border-radius: 50%; object-fit: cover; background: #444; border: 3px solid var(--dark); transition: border-color 0.1s; }
        
        /* –ò–Ω–¥–∏–∫–∞—Ç–æ—Ä—ã */
        .talking .avatar { border-color: #3ba55c; box-shadow: 0 0 15px rgba(59, 165, 92, 0.5); }
        .is-muted::after { content: 'üîá'; position: absolute; bottom: 0; right: 0; background: var(--darker); border-radius: 50%; padding: 4px; font-size: 14px; border: 2px solid var(--dark); }
        
        .user-name { margin-top: 10px; font-size: 14px; font-weight: 600; text-align: center; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 100%; color: white; }

        /* –ö–æ–Ω—Ç—Ä–æ–ª—ã */
        .controls { background: var(--darker); padding: 20px; display: flex; justify-content: center; gap: 25px; border-top: 1px solid #222; padding-bottom: max(20px, env(safe-area-inset-bottom)); }
        .btn-round { width: 56px; height: 56px; border-radius: 50%; border: none; cursor: pointer; display: flex; justify-content: center; align-items: center; font-size: 24px; color: white; background: var(--dark); box-shadow: 0 4px 10px rgba(0,0,0,0.3); transition: 0.2s; }
        .btn-round:active { transform: scale(0.95); }
        .btn-mute.active { background: var(--red); color: white; }
        .btn-exit { background: #222; }
    </style>
</head>
<body>

    <!-- –í–•–û–î -->
    <div id="login-screen">
        <div class="login-box">
            <h2>üéß –í—Ö–æ–¥</h2>
            <div style="font-size: 12px; color: #aaa; text-align: center;">–†–∞–±–æ—Ç–∞–µ—Ç –±–µ–∑ —Å–µ—Ä–≤–µ—Ä–∞ (P2P)</div>
            <input type="password" id="input-key" placeholder="–ü—Ä–∏–¥—É–º–∞–π—Ç–µ —Å–ª–æ–∂–Ω—ã–π –∫–ª—é—á">
            <input type="text" id="input-name" placeholder="–í–∞—à–µ –∏–º—è">
            <input type="text" id="input-photo" placeholder="–°—Å—ã–ª–∫–∞ –Ω–∞ —Ñ–æ—Ç–æ (–∏–ª–∏ –ø—É—Å—Ç–æ)">
            <button class="btn-primary" onclick="startApp()">–ü–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è</button>
        </div>
    </div>

    <!-- –ò–ù–¢–ï–†–§–ï–ô–° -->
    <header>
        <div style="font-weight: bold; display: flex; align-items: center; gap: 10px;">
            <span>Voice Room</span>
        </div>
        <div id="connection-status" class="status-badge">–û–∂–∏–¥–∞–Ω–∏–µ...</div>
    </header>

    <div id="users-grid"></div>

    <div class="controls">
        <button class="btn-round btn-mute" id="mute-btn" onclick="toggleMute()">üé§</button>
        <button class="btn-round btn-exit" onclick="logout()">üö™</button>
    </div>

    <script>
        // === –ö–û–ù–§–ò–ì–£–†–ê–¶–ò–Ø ===
        const APP_ID = 'my-discord-clone-v1'; // –£–Ω–∏–∫–∞–ª—å–Ω—ã–π ID –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è –≤ —Å–µ—Ç–∏ —Ç–æ—Ä—Ä–µ–Ω—Ç–æ–≤
        let room, sendData, localStream;
        let myUser = {};
        const peers = {}; // –•—Ä–∞–Ω–∏–º –¥–∞–Ω–Ω—ã–µ –æ –ø–∏—Ä–∞—Ö { peerId: { name, photo, muted } }

        // STUN —Å–µ—Ä–≤–µ—Ä–∞ –¥–ª—è –†–§ (—á—Ç–æ–±—ã –ø—Ä–æ–±–∏–≤–∞—Ç—å NAT)
        const rtcConfig = {
            iceServers: [
                { urls: 'stun:stun.l.google.com:19302' },
                { urls: 'stun:stun.sipnet.ru:3478' }
            ]
        };

        // –ó–∞–≥—Ä—É–∑–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö
        window.onload = () => {
            const stored = JSON.parse(localStorage.getItem('discord_lite_session'));
            if (stored) {
                document.getElementById('input-key').value = stored.key;
                document.getElementById('input-name').value = stored.name;
                document.getElementById('input-photo').value = stored.photo || '';
            }
        };

        async function startApp() {
            const key = document.getElementById('input-key').value.trim();
            const name = document.getElementById('input-name').value.trim();
            let photo = document.getElementById('input-photo').value.trim();
            
            if (!key || !name) return alert('–í–≤–µ–¥–∏—Ç–µ –∫–ª—é—á –∫–æ–º–Ω–∞—Ç—ã –∏ –∏–º—è!');
            if (!photo) photo = `https://ui-avatars.com/api/?name=${name}&background=random&color=fff`;

            // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Å–µ—Å—Å–∏—é
            myUser = { key, name, photo, isMuted: false };
            localStorage.setItem('discord_lite_session', JSON.stringify(myUser));

            try {
                // 1. –ü–æ–ª—É—á–∞–µ–º –¥–æ—Å—Ç—É–ø –∫ –º–∏–∫—Ä–æ—Ñ–æ–Ω—É
                localStream = await navigator.mediaDevices.getUserMedia({ audio: true, video: false });
                
                // 2. –°–∫—Ä—ã–≤–∞–µ–º –ª–æ–≥–∏–Ω
                document.getElementById('login-screen').style.display = 'none';
                
                // 3. –°–æ–∑–¥–∞–µ–º —Å–≤–æ—é –∫–∞—Ä—Ç–æ—á–∫—É
                renderUser('local', myUser);
                setupAudioVisualizer(localStream, 'local');
                
                // 4. –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º Trystero (P2P –º–∞–≥–∏—è)
                initTrystero(key);

            } catch (err) {
                console.error(err);
                alert('–û—à–∏–±–∫–∞: –ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –¥–æ—Å—Ç—É–ø –∫ –º–∏–∫—Ä–æ—Ñ–æ–Ω—É. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Ä–∞–∑—Ä–µ—à–µ–Ω–∏—è –∏ HTTPS.');
            }
        }

        function initTrystero(roomId) {
            const connectionStatus = document.getElementById('connection-status');
            connectionStatus.innerText = '–ü–æ–∏—Å–∫ –ø–∏—Ä–æ–≤...';

            // –ü—Ä–∏—Å–æ–µ–¥–∏–Ω—è–µ–º—Å—è –∫ –∫–æ–º–Ω–∞—Ç–µ (–∏—Å–ø–æ–ª—å–∑—É–µ–º Torrent —Ç—Ä–µ–∫–µ—Ä—ã –∫–∞–∫ —Å–∏–≥–Ω–∞–ª–∏–Ω–≥)
            room = Trystero.joinRoom({ appId: APP_ID, rtcConfig }, roomId);

            // –ö–∞–Ω–∞–ª –¥–ª—è –æ–±–º–µ–Ω–∞ –¥–∞–Ω–Ω—ã–º–∏ (–∏–º—è, —Ñ–æ—Ç–æ, —Å—Ç–∞—Ç—É—Å –º—É—Ç–∞)
            const [sendDataAction, getDataAction] = room.makeAction('user-info');
            sendData = sendDataAction;

            // === –°–û–ë–´–¢–ò–Ø ===

            // 1. –ö—Ç–æ-—Ç–æ –≤–æ—à–µ–ª
            room.onPeerJoin(peerId => {
                console.log('Peer joined:', peerId);
                connectionStatus.innerText = '–û–Ω–ª–∞–π–Ω';
                connectionStatus.classList.add('online');
                // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –µ–º—É —Å–≤–æ–∏ –¥–∞–Ω–Ω—ã–µ —Å—Ä–∞–∑—É
                sendData({ id: 'local', ...myUser }, peerId);
            });

            // 2. –ö—Ç–æ-—Ç–æ –≤—ã—à–µ–ª
            room.onPeerLeave(peerId => {
                document.getElementById(`user-${peerId}`)?.remove();
                delete peers[peerId];
            });

            // 3. –ü—Ä–∏—à–µ–ª –∞—É–¥–∏–æ-–ø–æ—Ç–æ–∫
            room.onPeerStream((stream, peerId) => {
                // –°–æ–∑–¥–∞–µ–º –∞—É–¥–∏–æ —ç–ª–µ–º–µ–Ω—Ç
                let audio = new Audio();
                audio.srcObject = stream;
                audio.autoplay = true;
                audio.playsInline = true; // –î–ª—è iOS
                document.body.appendChild(audio);

                // –ï—Å–ª–∏ –∫–∞—Ä—Ç–æ—á–∫–∏ –µ—â–µ –Ω–µ—Ç (–ø–æ—Ç–æ–∫ –ø—Ä–∏—à–µ–ª —Ä–∞–Ω—å—à–µ –¥–∞–Ω–Ω—ã—Ö), —Å–æ–∑–¥–∞–µ–º –∑–∞–≥–ª—É—à–∫—É
                if (!document.getElementById(`user-${peerId}`)) {
                    renderUser(peerId, { name: '–ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ...', photo: 'https://via.placeholder.com/70' });
                }
                
                setupAudioVisualizer(stream, peerId);
            });

            // 4. –ü—Ä–∏—à–ª–∏ –¥–∞–Ω–Ω—ã–µ (–∏–º—è, —Ñ–æ—Ç–æ, –º—É—Ç)
            getDataAction((data, peerId) => {
                // –ï—Å–ª–∏ —ç—Ç–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞ –º—É—Ç–∞
                if (data.type === 'mute-status') {
                    toggleUserMuteUI(peerId, data.isMuted);
                    return;
                }

                // –ò–Ω–∞—á–µ —ç—Ç–æ –ø—Ä–æ—Ñ–∏–ª—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
                peers[peerId] = data;
                renderUser(peerId, data);
            });

            // –î–æ–±–∞–≤–ª—è–µ–º —Å–≤–æ–π –ø–æ—Ç–æ–∫ –≤ –∫–æ–º–Ω–∞—Ç—É (—á—Ç–æ–±—ã –Ω–∞—Å —Å–ª—ã—à–∞–ª–∏)
            room.addStream(localStream);
        }

        // === UI –§–£–ù–ö–¶–ò–ò ===

        function renderUser(id, data) {
            let card = document.getElementById(`user-${id}`);
            if (!card) {
                card = document.createElement('div');
                card.id = `user-${id}`;
                card.className = 'user-card';
                document.getElementById('users-grid').appendChild(card);
            }
            
            // –ï—Å–ª–∏ id='local', –¥–æ–±–∞–≤–ª—è–µ–º –º–µ—Ç–∫—É (–í—ã)
            const nameDisplay = id === 'local' ? `${data.name} (–í—ã)` : data.name;

            card.innerHTML = `
                <div class="avatar-wrapper ${data.isMuted ? 'is-muted' : ''}">
                    <img src="${data.photo}" class="avatar">
                </div>
                <div class="user-name">${nameDisplay}</div>
            `;
        }

        function toggleMute() {
            const track = localStream.getAudioTracks()[0];
            const isMuted = track.enabled; // –°–µ–π—á–∞—Å –≤–∫–ª—é—á–µ–Ω?
            track.enabled = !isMuted; // –ü–µ—Ä–µ–∫–ª—é—á–∞–µ–º

            myUser.isMuted = !track.enabled;

            // –û–±–Ω–æ–≤–ª—è–µ–º –∫–Ω–æ–ø–∫—É
            const btn = document.getElementById('mute-btn');
            const myAvatar = document.querySelector('#user-local .avatar-wrapper');
            
            if (myUser.isMuted) {
                btn.classList.add('active');
                btn.innerText = 'üîá';
                myAvatar.classList.add('is-muted');
            } else {
                btn.classList.remove('active');
                btn.innerText = 'üé§';
                myAvatar.classList.remove('is-muted');
            }

            // –†–∞—Å—Å—ã–ª–∞–µ–º –≤—Å–µ–º –Ω–æ–≤—ã–π —Å—Ç–∞—Ç—É—Å
            if (sendData) {
                sendData({ type: 'mute-status', isMuted: myUser.isMuted });
            }
        }

        function toggleUserMuteUI(peerId, isMuted) {
            const card = document.getElementById(`user-${peerId}`);
            if (card) {
                const wrapper = card.querySelector('.avatar-wrapper');
                if (isMuted) wrapper.classList.add('is-muted');
                else wrapper.classList.remove('is-muted');
            }
        }

        function logout() {
            if (confirm('–í—ã–π—Ç–∏ –∏–∑ –∫–æ–º–Ω–∞—Ç—ã?')) {
                localStorage.removeItem('discord_lite_session');
                location.reload();
            }
        }

        // === –í–ò–ó–£–ê–õ–ò–ó–ê–¶–ò–Ø –ì–û–õ–û–°–ê ===
        function setupAudioVisualizer(stream, elementId) {
            const ctx = new (window.AudioContext || window.webkitAudioContext)();
            const src = ctx.createMediaStreamSource(stream);
            const analyser = ctx.createAnalyser();
            analyser.fftSize = 64;
            src.connect(analyser);
            
            const data = new Uint8Array(analyser.frequencyBinCount);
            
            function draw() {
                // –ï—Å–ª–∏ —ç–ª–µ–º–µ–Ω—Ç —É–¥–∞–ª–µ–Ω (—é–∑–µ—Ä –≤—ã—à–µ–ª), –æ—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∞–Ω–∏–º–∞—Ü–∏—é
                const card = document.getElementById(`user-${elementId}`);
                if (!card) return;

                analyser.getByteFrequencyData(data);
                // –°—á–∏—Ç–∞–µ–º —Å—Ä–µ–¥–Ω—é—é –≥—Ä–æ–º–∫–æ—Å—Ç—å
                let sum = 0;
                for(let i=0; i < data.length; i++) sum += data[i];
                const avg = sum / data.length;

                if (avg > 10) card.classList.add('talking');
                else card.classList.remove('talking');

                requestAnimationFrame(draw);
            }
            draw();
        }
    </script>
</body>
</html>
