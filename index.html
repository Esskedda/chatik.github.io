<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>PITBULL X: NEURAL CORE</title>
    <!-- MQTT Signaling -->
    <script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>
    <!-- RNNoise Wasm Loader (Шумоподавление как в Discord/Telemost) -->
    <script src="https://unpkg.com/@shiguredo/noise-suppression@latest/dist/noise-suppression.js"></script>
    
    <style>
        :root {
            --bg: #0f0f13;
            --card: #18181b;
            --accent: #9d4edd;
            --accent-glow: rgba(157, 78, 221, 0.4);
            --danger: #ff4b4b;
            --text: #ececec;
        }
        
        body { margin: 0; background: var(--bg); color: var(--text); font-family: 'Segoe UI', system-ui, sans-serif; overflow: hidden; height: 100vh; }
        * { box-sizing: border-box; outline: none; -webkit-tap-highlight-color: transparent; }

        /* --- LOGIN SCREEN --- */
        #login-wrap { display: flex; height: 100vh; justify-content: center; align-items: center; background: radial-gradient(circle at 50% 50%, #240046 0%, #000 100%); }
        .login-box { width: 340px; padding: 40px; background: rgba(255,255,255,0.03); border: 1px solid rgba(255,255,255,0.1); border-radius: 24px; text-align: center; backdrop-filter: blur(20px); box-shadow: 0 20px 50px rgba(0,0,0,0.5); }
        .logo { font-size: 24px; font-weight: 900; letter-spacing: 2px; margin-bottom: 30px; background: linear-gradient(to right, #e0aaff, #9d4edd); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        
        .avatar-picker { width: 90px; height: 90px; margin: 0 auto 25px; border-radius: 50%; background: #2a2a2a; border: 2px dashed #555; cursor: pointer; display: flex; align-items: center; justify-content: center; overflow: hidden; position: relative; transition: 0.3s; }
        .avatar-picker:hover { border-color: var(--accent); transform: scale(1.05); }
        .avatar-img { width: 100%; height: 100%; object-fit: cover; display: none; }
        
        input.field { width: 100%; background: rgba(0,0,0,0.4); border: 1px solid #333; color: white; padding: 14px; border-radius: 12px; margin-bottom: 15px; text-align: center; font-size: 16px; transition: 0.2s; }
        input.field:focus { border-color: var(--accent); box-shadow: 0 0 15px var(--accent-glow); }
        
        button.btn-main { width: 100%; padding: 14px; border-radius: 12px; border: none; font-weight: 700; background: linear-gradient(135deg, #9d4edd, #5a189a); color: white; cursor: pointer; transition: 0.2s; font-size: 16px; letter-spacing: 1px; }
        button.btn-main:hover { transform: translateY(-2px); box-shadow: 0 10px 25px var(--accent-glow); }

        /* --- APP UI --- */
        #app-ui { display: none; height: 100vh; flex-direction: column; padding: 15px; }
        
        /* Grid */
        .grid { flex: 1; display: grid; grid-template-columns: repeat(auto-fit, minmax(160px, 1fr)); grid-auto-rows: 200px; gap: 15px; overflow-y: auto; padding-bottom: 80px; }
        
        .card { background: var(--card); border-radius: 18px; position: relative; overflow: hidden; border: 1px solid rgba(255,255,255,0.05); display: flex; flex-direction: column; align-items: center; justify-content: center; transition: 0.2s; }
        .card.speaking { border-color: var(--accent); box-shadow: 0 0 20px var(--accent-glow); }
        
        .card video { position: absolute; inset: 0; width: 100%; height: 100%; object-fit: cover; z-index: 0; display: none; }
        .card.has-video video { display: block; }
        
        .card-ava { width: 70px; height: 70px; border-radius: 35px; background-size: cover; z-index: 2; margin-bottom: 10px; box-shadow: 0 5px 20px rgba(0,0,0,0.5); }
        .card-name { z-index: 2; font-weight: 600; font-size: 14px; text-shadow: 0 2px 5px black; }
        
        .status-badge { position: absolute; top: 10px; right: 10px; background: rgba(0,0,0,0.6); padding: 4px 8px; border-radius: 6px; font-size: 10px; z-index: 3; color: #aaa; display: flex; align-items: center; gap: 5px; }
        .status-dot { width: 6px; height: 6px; border-radius: 50%; background: #555; }
        .status-dot.active { background: #00f260; box-shadow: 0 0 5px #00f260; }

        /* Controls */
        .controls { position: fixed; bottom: 30px; left: 50%; transform: translateX(-50%); display: flex; gap: 15px; background: rgba(20,20,25,0.85); backdrop-filter: blur(20px); padding: 10px 25px; border-radius: 40px; border: 1px solid rgba(255,255,255,0.1); box-shadow: 0 20px 50px rgba(0,0,0,0.6); z-index: 100; }
        
        .c-btn { width: 50px; height: 50px; border-radius: 25px; border: none; background: rgba(255,255,255,0.1); color: white; cursor: pointer; display: flex; flex-direction: column; align-items: center; justify-content: center; transition: 0.2s; position: relative; }
        .c-btn:hover { background: rgba(255,255,255,0.2); transform: translateY(-3px); }
        .c-btn.active { background: white; color: black; }
        .c-btn.red { background: rgba(255, 75, 75, 0.2); color: var(--danger); }
        
        .ai-badge { position: absolute; top: -5px; right: -5px; background: linear-gradient(45deg, #00f260, #0575e6); font-size: 8px; font-weight: bold; padding: 2px 6px; border-radius: 6px; color: white; display: none; box-shadow: 0 2px 5px rgba(0,0,0,0.3); }
        .c-btn.ai-on .ai-badge { display: block; }
        
        /* Volume Slider */
        .vol-wrap { width: 80%; z-index: 10; margin-top: 10px; opacity: 0; transition: 0.3s; }
        .card:hover .vol-wrap { opacity: 1; }
        input[type=range] { width: 100%; height: 4px; background: rgba(255,255,255,0.2); border-radius: 2px; -webkit-appearance: none; }
        input[type=range]::-webkit-slider-thumb { -webkit-appearance: none; width: 12px; height: 12px; background: white; border-radius: 50%; cursor: pointer; }
    </style>
</head>
<body>

<!-- LOGIN -->
<div id="login-wrap">
    <div class="login-box">
        <div class="logo">PITBULL X</div>
        <div class="avatar-picker" onclick="document.getElementById('file-in').click()">
            <span style="font-size:30px; opacity:0.5; color:white">+</span>
            <img id="ava-preview" class="avatar-img">
        </div>
        <input type="file" id="file-in" hidden accept="image/*">
        <input id="nick-in" class="field" placeholder="Позывной">
        <button class="btn-main" onclick="CORE.login()">ВОЙТИ В ЭФИР</button>
        <div style="font-size:11px; opacity:0.4; margin-top:20px">Powered by RNNoise AI (Wasm)</div>
    </div>
</div>

<!-- APP -->
<div id="app-ui">
    <div class="grid" id="grid"></div>
    
    <div class="controls">
        <button class="c-btn active ai-on" id="btn-mic" onclick="CORE.toggleMic()">
            <span class="ai-badge">AI</span>
            <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor"><path d="M12 14c1.66 0 3-1.34 3-3V5c0-1.66-1.34-3-3-3S9 3.34 9 5v6c0 1.66 1.34 3 3 3z"/><path d="M17 11c0 2.76-2.24 5-5 5s-5-2.24-5-5H5c0 3.53 2.61 6.43 6 6.92V21h2v-3.08c3.39-.49 6-3.39 6-6.92h-2z"/></svg>
        </button>
        <button class="c-btn" id="btn-scr" onclick="CORE.toggleScreen()">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor"><path d="M21 3H3c-1.11 0-2 .89-2 2v12c0 1.1.89 2 2 2h5v2h8v-2h5c1.1 0 1.99-.9 1.99-2L23 5c0-1.11-.9-2-2-2zm0 14H3V5h18v12z"/></svg>
        </button>
        <button class="c-btn red" onclick="location.reload()">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor"><path d="M10.09 15.59L11.5 17l5-5-5-5-1.41 1.41L12.67 11H3v2h9.67l-2.58 2.59zM19 3H5a2 2 0 0 0-2 2v4h2V5h14v14H5v-4H3v4a2 2 0 0 0 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2z"/></svg>
        </button>
    </div>
</div>

<script>
// --- CONFIG ---
const CFG = {
    mqtt: 'wss://broker.emqx.io:8084/mqtt',
    room: 'pitbull_x_neural_v1',
    ice: { iceServers: [{ urls: 'stun:stun.l.google.com:19302' }, { urls: 'stun:stun4.l.google.com:19302' }] }
};

// --- RNNOISE PROCESSOR (ШУМОДАВ) ---
class NeuralProcessor {
    constructor() {
        this.ctx = new (window.AudioContext || window.webkitAudioContext)();
        this.nsNode = null;
        this.isAiActive = true;
        this.assetsLoaded = false;
    }

    async loadAssets() {
        if(this.assetsLoaded) return;
        // Загружаем Wasm модуль из CDN
        await NoiseSuppression.load('https://unpkg.com/@shiguredo/noise-suppression@latest/dist/');
        this.assetsLoaded = true;
    }

    async process(stream) {
        if(this.ctx.state === 'suspended') await this.ctx.resume();
        await this.loadAssets();

        const source = this.ctx.createMediaStreamSource(stream);
        const dest = this.ctx.createMediaStreamDestination();

        // Создаем ноду шумодава RNNoise
        this.nsNode = new NoiseSuppression.NoiseSuppressionNode(this.ctx, {
            isEnabled: true
        });

        // Цепочка: Mic -> AI Noise Suppressor -> Destination
        source.connect(this.nsNode);
        this.nsNode.connect(dest);

        return dest.stream;
    }

    toggle(state) {
        if(this.nsNode) {
            this.isAiActive = state;
            // В библиотеке shiguredo может не быть прямого API enabled, 
            // поэтому мы делаем bypass иначе, но для простоты пересоздаем граф или оставляем всегда включенным.
            // В данном случае мы всегда держим его включенным, т.к. "как в телемосте" = всегда работает.
            console.log("AI Noise Suppression is always ON for best quality");
        }
    }
}

// --- CORE LOGIC ---
const CORE = {
    myId: 'u_' + Math.random().toString(36).substr(2, 6),
    me: { name: '', ava: '' },
    peers: {},
    client: null,
    audio: new NeuralProcessor(),
    localStream: null,
    screenStream: null,
    isMuted: false,

    init() {
        document.getElementById('file-in').onchange = (e) => {
            const r = new FileReader();
            r.onload = ev => {
                this.me.ava = ev.target.result;
                const img = document.getElementById('ava-preview');
                img.src = ev.target.result;
                img.style.display = 'block';
            };
            r.readAsDataURL(e.target.files[0]);
        };
    },

    async login() {
        const name = document.getElementById('nick-in').value;
        if(!name) return alert("Введите позывной!");
        this.me.name = name;
        if(!this.me.ava) this.me.ava = `https://api.dicebear.com/7.x/bottts/svg?seed=${this.myId}`;

        document.getElementById('login-wrap').style.display = 'none';
        document.getElementById('app-ui').style.display = 'flex';

        try {
            // 1. RAW MIC
            const rawStream = await navigator.mediaDevices.getUserMedia({
                audio: {
                    echoCancellation: true, // Хардварное эхоподавление (обязательно)
                    noiseSuppression: false, // ВЫКЛЮЧАЕМ стандартный, включаем AI
                    autoGainControl: true
                },
                video: false
            });

            // 2. AI PROCESSING
            console.log("Starting AI Noise Suppression...");
            this.localStream = await this.audio.process(rawStream);
            
            // Визуализация себя
            this.renderCard(this.myId, this.me, true);
            this.setupVolumeMeter(rawStream, this.myId); // Метрика с сырого звука для "мигания"

            // 3. CONNECT
            this.connectMQTT();

        } catch(e) {
            alert("Mic Error: " + e.message);
        }
    },

    connectMQTT() {
        this.client = mqtt.connect(CFG.mqtt, { clientId: this.myId, keepalive: 60 });
        
        this.client.on('connect', () => {
            console.log("Connected to Signal Server");
            this.client.subscribe(`${CFG.room}/#`);
            this.announce();
            setInterval(() => this.announce(), 4000);
        });

        this.client.on('message', (topic, msg) => {
            if(topic.includes(this.myId)) return;
            try {
                const d = JSON.parse(msg.toString());
                if(topic.includes('presence')) this.handlePresence(d);
                if(topic.includes('signal/' + this.myId)) this.handleSignal(d);
            } catch(e) {}
        });
    },

    announce() {
        this.client.publish(`${CFG.room}/presence`, JSON.stringify({ id: this.myId, user: this.me }));
    },

    handlePresence(d) {
        if(this.peers[d.id]) return;
        this.renderCard(d.id, d.user, false);
        this.connectPeer(d.id, this.myId < d.id); // Perfect Negotiation Role
    },

    connectPeer(uid, polite) {
        const pc = new RTCPeerConnection(CFG.ice);
        this.peers[uid] = { pc, polite, makingOffer: false, ignoreOffer: false };

        // Add Tracks
        this.localStream.getTracks().forEach(t => pc.addTrack(t, this.localStream));
        if(this.screenStream) this.screenStream.getTracks().forEach(t => pc.addTrack(t, this.screenStream));

        // Handle Remote
        pc.ontrack = e => {
            const stream = e.streams[0];
            if(e.track.kind === 'audio') {
                const audio = new Audio();
                audio.srcObject = stream;
                audio.autoplay = true;
                audio.id = `aud-${uid}`;
                document.body.appendChild(audio);
                this.setupVolumeMeter(stream, uid); // Метрика входящего
            } else {
                this.attachVideo(uid, stream);
            }
        };

        // Perfect Negotiation Logic
        pc.onnegotiationneeded = async () => {
            try {
                this.peers[uid].makingOffer = true;
                await pc.setLocalDescription();
                this.sendSig(uid, { desc: pc.localDescription });
            } catch(e) { console.error(e); } 
            finally { this.peers[uid].makingOffer = false; }
        };

        pc.onicecandidate = e => { if(e.candidate) this.sendSig(uid, { cand: e.candidate }); };
    },

    async handleSignal(d) {
        const { sender, data } = d;
        const p = this.peers[sender];
        if(!p) return;

        try {
            if(data.desc) {
                const offerCollision = (data.desc.type === "offer") && (p.makingOffer || p.pc.signalingState !== "stable");
                p.ignoreOffer = !p.polite && offerCollision;
                if(p.ignoreOffer) return;

                if(offerCollision) await Promise.all([p.pc.setLocalDescription({type: "rollback"}), p.pc.setRemoteDescription(data.desc)]);
                else await p.pc.setRemoteDescription(data.desc);

                if(data.desc.type === "offer") {
                    await p.pc.setLocalDescription();
                    this.sendSig(sender, { desc: p.pc.localDescription });
                }
            } else if(data.cand) {
                try { await p.pc.addIceCandidate(data.cand); } catch(e) { if(!p.ignoreOffer) throw e; }
            }
        } catch(e) { console.error(e); }
    },

    sendSig(to, data) {
        this.client.publish(`${CFG.room}/signal/${to}`, JSON.stringify({ sender: this.myId, data }));
    },

    // --- UI ---
    renderCard(uid, user, isMe) {
        if(document.getElementById(`card-${uid}`)) return;
        const grid = document.getElementById('grid');
        const card = document.createElement('div');
        card.className = 'card';
        card.id = `card-${uid}`;
        card.innerHTML = `
            <video autoplay playsinline muted></video>
            <div class="card-ava" style="background-image: url('${user.ava}')"></div>
            <div class="card-name">${user.name}</div>
            <div class="status-badge"><div class="status-dot active"></div>LIVE</div>
            ${!isMe ? `<div class="vol-wrap"><input type="range" min="0" max="100" value="100" oninput="CORE.setVol('${uid}', this.value)"></div>` : ''}
        `;
        grid.appendChild(card);
    },

    setVol(uid, val) {
        const el = document.getElementById(`aud-${uid}`);
        if(el) el.volume = val / 100;
    },

    attachVideo(uid, stream) {
        const c = document.getElementById(`card-${uid}`);
        if(c) {
            const v = c.querySelector('video');
            v.srcObject = stream;
            stream ? c.classList.add('has-video') : c.classList.remove('has-video');
        }
    },

    toggleMic() {
        this.isMuted = !this.isMuted;
        document.getElementById('btn-mic').classList.toggle('active');
        // Mute RAW stream to save bandwidth
        this.localStream.getAudioTracks().forEach(t => t.enabled = !this.isMuted);
    },

    async toggleScreen() {
        if(this.screenStream) {
            this.screenStream.getTracks().forEach(t => t.stop());
            this.screenStream = null;
            document.getElementById('btn-scr').classList.remove('active');
            this.attachVideo(this.myId, null);
        } else {
            try {
                this.screenStream = await navigator.mediaDevices.getDisplayMedia({video: true});
                this.screenStream.getVideoTracks()[0].onended = () => this.toggleScreen();
                document.getElementById('btn-scr').classList.add('active');
                
                this.attachVideo(this.myId, this.screenStream);
                // Add to peers
                Object.values(this.peers).forEach(p => {
                    this.screenStream.getTracks().forEach(t => p.pc.addTrack(t, this.screenStream));
                });
            } catch(e) {}
        }
    },

    // Visualizer logic
    setupVolumeMeter(stream, uid) {
        const ctx = new AudioContext();
        const src = ctx.createMediaStreamSource(stream);
        const anal = ctx.createAnalyser();
        anal.fftSize = 256;
        src.connect(anal);
        
        const data = new Uint8Array(anal.frequencyBinCount);
        const loop = () => {
            anal.getByteFrequencyData(data);
            let sum = 0;
            for(let i=0; i<data.length; i++) sum += data[i];
            const avg = sum / data.length;
            
            const card = document.getElementById(`card-${uid}`);
            if(card) {
                if(avg > 15) card.classList.add('speaking');
                else card.classList.remove('speaking');
            }
            requestAnimationFrame(loop);
        };
        loop();
    }
};

CORE.init();
</script>
</body>
</html>
