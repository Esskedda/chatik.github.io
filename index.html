<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Voice Chat v3.0 (Debug)</title>
    <script src="https://unpkg.com/trystero@0.17.0/dist/trystero-torrent.min.js"></script>
    
    <style>
        :root { --bg: #202225; --dark: #2f3136; --accent: #5865f2; --text: #fff; --red: #ed4245; --green: #3ba55c; }
        * { box-sizing: border-box; }
        body { margin: 0; background: var(--bg); color: var(--text); font-family: sans-serif; height: 100vh; display: flex; flex-direction: column; }
        
        /* –í—Ö–æ–¥ */
        #login-screen { position: fixed; inset: 0; background: var(--bg); z-index: 99; display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 20px; }
        .box { background: var(--dark); padding: 20px; border-radius: 10px; width: 100%; max-width: 320px; display: flex; flex-direction: column; gap: 10px; }
        input { padding: 12px; background: #202225; border: 1px solid #000; color: white; border-radius: 5px; }
        button { padding: 12px; border: none; border-radius: 5px; cursor: pointer; font-weight: bold; background: var(--accent); color: white; }
        
        /* –ß–∞—Ç */
        header { padding: 15px; background: var(--dark); border-bottom: 1px solid #000; display: flex; justify-content: space-between; align-items: center; }
        #status-badge { font-size: 12px; padding: 4px 8px; background: #444; border-radius: 4px; }
        .online { background: var(--green) !important; color: white; }

        #grid { flex: 1; padding: 20px; display: flex; flex-wrap: wrap; gap: 15px; align-content: flex-start; overflow-y: auto; }
        
        .user-card { background: var(--dark); padding: 15px; border-radius: 8px; width: 100px; display: flex; flex-direction: column; align-items: center; position: relative; }
        .avatar { width: 60px; height: 60px; border-radius: 50%; background: #555; object-fit: cover; border: 3px solid transparent; }
        .talking { border-color: var(--green); box-shadow: 0 0 10px var(--green); }
        .name { margin-top: 8px; font-size: 12px; text-align: center; word-break: break-all; }
        .mic-icon { position: absolute; top: 5px; right: 5px; background: rgba(0,0,0,0.6); border-radius: 50%; padding: 3px; font-size: 10px; display: none; }
        .is-muted .mic-icon { display: block; }

        /* –ö–æ–Ω—Å–æ–ª—å –æ—à–∏–±–æ–∫ */
        #debug-console { height: 100px; background: #000; color: #0f0; font-family: monospace; font-size: 10px; padding: 10px; overflow-y: auto; border-top: 1px solid #333; }

        .controls { padding: 20px; background: var(--dark); display: flex; justify-content: center; gap: 15px; }
        .btn-circle { width: 50px; height: 50px; border-radius: 50%; border: none; background: #40444b; color: white; font-size: 20px; cursor: pointer; }
        .btn-active { background: var(--red); }
    </style>
</head>
<body>

    <div id="login-screen">
        <h2>üöÄ Voice Chat v3</h2>
        <div class="box">
            <input id="key" placeholder="–ü—Ä–∏–¥—É–º–∞–π—Ç–µ –ø–∞—Ä–æ–ª—å –∫–æ–º–Ω–∞—Ç—ã">
            <input id="nick" placeholder="–í–∞—à–µ –∏–º—è">
            <button onclick="startApp()">–í–æ–π—Ç–∏ –≤ –∫–æ–º–Ω–∞—Ç—É</button>
        </div>
        <p style="font-size: 12px; color: #aaa; text-align: center;">–ï—Å–ª–∏ –º–∏–∫—Ä–æ—Ñ–æ–Ω –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç, –≤—ã —Å–º–æ–∂–µ—Ç–µ —Ç–æ–ª—å–∫–æ —Å–ª—É—à–∞—Ç—å.</p>
    </div>

    <header>
        <b>–ö–æ–º–Ω–∞—Ç–∞</b>
        <div id="status-badge">–û–∂–∏–¥–∞–Ω–∏–µ...</div>
    </header>

    <div id="grid"></div>

    <div id="debug-console">–õ–æ–≥ —Å–æ–±—ã—Ç–∏–π –±—É–¥–µ—Ç –∑–¥–µ—Å—å...<br></div>

    <div class="controls">
        <button id="mic-btn" class="btn-circle" onclick="toggleMic()">üé§</button>
        <button class="btn-circle" style="background: #222;" onclick="location.reload()">üö™</button>
    </div>

    <script>
        const config = { appId: 'ru-voice-chat-universal-v1' }; // –ï–¥–∏–Ω—ã–π ID –¥–ª—è –ª—É—á—à–µ–≥–æ –ø–æ–∏—Å–∫–∞
        let room, localStream, sendMeta;
        let myId = Math.random().toString(36).substr(2, 6);
        let myNick = 'User';

        function log(msg) {
            const c = document.getElementById('debug-console');
            c.innerHTML += `> ${msg}<br>`;
            c.scrollTop = c.scrollHeight;
            console.log(msg);
        }

        async function startApp() {
            const key = document.getElementById('key').value.trim();
            myNick = document.getElementById('nick').value.trim() || 'Anon';
            
            if(!key) return alert('–í–≤–µ–¥–∏—Ç–µ –ø–∞—Ä–æ–ª—å –∫–æ–º–Ω–∞—Ç—ã!');

            document.getElementById('login-screen').style.display = 'none';
            log('–ó–∞–ø—É—Å–∫ —Å–∏—Å—Ç–µ–º—ã...');

            // 1. –ü—ã—Ç–∞–µ–º—Å—è –ø–æ–ª—É—á–∏—Ç—å –º–∏–∫—Ä–æ—Ñ–æ–Ω
            try {
                localStream = await navigator.mediaDevices.getUserMedia({ audio: true });
                log('‚úÖ –ú–∏–∫—Ä–æ—Ñ–æ–Ω –ø–æ–ª—É—á–µ–Ω');
                renderUser(myId, myNick, true);
                monitorAudio(localStream, myId);
            } catch (e) {
                log('‚ö†Ô∏è –û–®–ò–ë–ö–ê –ú–ò–ö–†–û–§–û–ù–ê: ' + e.message);
                log('–í—Ö–æ–¥ –≤ —Ä–µ–∂–∏–º–µ "–¢–æ–ª—å–∫–æ –ø—Ä–æ—Å–ª—É—à–∏–≤–∞–Ω–∏–µ"');
                localStream = null; // –†–∞–±–æ—Ç–∞–µ–º –±–µ–∑ –∑–≤—É–∫–∞
                renderUser(myId, myNick + ' (–ë–µ–∑ –∑–≤—É–∫–∞)', true);
                document.getElementById('mic-btn').disabled = true;
                document.getElementById('mic-btn').style.opacity = 0.5;
            }

            // 2. –ü–æ–¥–∫–ª—é—á–∞–µ–º—Å—è –∫ —Å–µ—Ç–∏ P2P
            initNetwork(key);
        }

        function initNetwork(roomId) {
            log(`–ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –∫–æ–º–Ω–∞—Ç–µ: ${roomId}`);
            
            // –ò—Å–ø–æ–ª—å–∑—É–µ–º –ø–∞—Ä–æ–ª—å –∫–∞–∫ ID –∫–æ–º–Ω–∞—Ç—ã –≤–Ω—É—Ç—Ä–∏ –æ–±—â–µ–≥–æ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
            room = Trystero.joinRoom(config, roomId);

            // –û–±—Ä–∞–±–æ—Ç–∫–∞ –¥–∞–Ω–Ω—ã—Ö
            const [send, get] = room.makeAction('userParams');
            sendMeta = send;

            // --- –°–û–ë–´–¢–ò–Ø ---
            
            room.onPeerJoin(id => {
                log(`‚ûï –ü–æ–¥–∫–ª—é—á–∏–ª—Å—è –ø–∏—Ä: ${id}`);
                document.getElementById('status-badge').innerText = '–û–Ω–ª–∞–π–Ω';
                document.getElementById('status-badge').classList.add('online');
                
                // –®–ª–µ–º –µ–º—É —Å–≤–æ–∏ –¥–∞–Ω–Ω—ã–µ
                const isMuted = localStream ? !localStream.getAudioTracks()[0].enabled : true;
                send({ name: myNick, muted: isMuted }, id);

                // –ï—Å–ª–∏ —É –Ω–∞—Å –µ—Å—Ç—å –º–∏–∫—Ä–æ—Ñ–æ–Ω, –¥–æ–±–∞–≤–ª—è–µ–º –ø–æ—Ç–æ–∫ —Å–Ω–æ–≤–∞ (–¥–ª—è –Ω–∞–¥–µ–∂–Ω–æ—Å—Ç–∏)
                if(localStream) room.addStream(localStream, id);
            });

            room.onPeerLeave(id => {
                log(`‚ûñ –í—ã—à–µ–ª –ø–∏—Ä: ${id}`);
                document.getElementById('user-'+id)?.remove();
            });

            room.onPeerStream((stream, id) => {
                log(`üîä –ü—Ä–∏—à–µ–ª –∑–≤—É–∫ –æ—Ç ${id}`);
                
                // –°–æ–∑–¥–∞–µ–º –∞—É–¥–∏–æ
                const audio = new Audio();
                audio.srcObject = stream;
                audio.autoplay = true;
                audio.playsInline = true;
                document.body.appendChild(audio);

                // –ï—Å–ª–∏ –∫–∞—Ä—Ç–æ—á–∫–∏ –Ω–µ—Ç - —Å–æ–∑–¥–∞–µ–º
                if(!document.getElementById('user-'+id)) {
                    renderUser(id, '–ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ...', false);
                }
                monitorAudio(stream, id);
            });

            get((data, id) => {
                // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∏–º–µ–Ω–∏ –∏ —Å—Ç–∞—Ç—É—Å–∞
                if(!document.getElementById('user-'+id)) renderUser(id, data.name, false);
                
                const card = document.getElementById('user-'+id);
                if(card) {
                    card.querySelector('.name').innerText = data.name;
                    if(data.muted) card.classList.add('is-muted');
                    else card.classList.remove('is-muted');
                }
            });

            // –ï—Å–ª–∏ –µ—Å—Ç—å –º–∏–∫—Ä–æ—Ñ–æ–Ω, —Ç—Ä–∞–Ω—Å–ª–∏—Ä—É–µ–º –µ–≥–æ
            if(localStream) {
                room.addStream(localStream);
                log('üì° –¢—Ä–∞–Ω—Å–ª—è—Ü–∏—è –∑–∞–ø—É—â–µ–Ω–∞');
            } else {
                log('üéß –†–µ–∂–∏–º —Å–ª—É—à–∞—Ç–µ–ª—è –∞–∫—Ç–∏–≤–µ–Ω');
            }
        }

        // --- –ì–†–ê–§–ò–ö–ê ---
        function renderUser(id, name, isLocal) {
            if(document.getElementById('user-'+id)) return;
            const grid = document.getElementById('grid');
            const ava = `https://ui-avatars.com/api/?name=${name}&background=random&color=fff`;
            
            const div = document.createElement('div');
            div.className = 'user-card';
            div.id = 'user-'+id;
            div.innerHTML = `
                <div class="mic-icon">üîá</div>
                <img src="${ava}" class="avatar">
                <div class="name">${name}</div>
            `;
            grid.appendChild(div);
        }

        function toggleMic() {
            if(!localStream) return;
            const track = localStream.getAudioTracks()[0];
            track.enabled = !track.enabled;
            
            const btn = document.getElementById('mic-btn');
            const myCard = document.getElementById('user-'+myId);
            
            if(track.enabled) {
                btn.classList.remove('btn-active');
                btn.innerText = 'üé§';
                myCard.classList.remove('is-muted');
                log('–ú–∏–∫—Ä–æ—Ñ–æ–Ω –≤–∫–ª—é—á–µ–Ω');
            } else {
                btn.classList.add('btn-active');
                btn.innerText = 'üîá';
                myCard.classList.add('is-muted');
                log('–ú–∏–∫—Ä–æ—Ñ–æ–Ω –≤—ã–∫–ª—é—á–µ–Ω');
            }
            
            if(sendMeta) sendMeta({ name: myNick, muted: !track.enabled });
        }

        function monitorAudio(stream, id) {
            try {
                const ctx = new (window.AudioContext || window.webkitAudioContext)();
                const src = ctx.createMediaStreamSource(stream);
                const analyzer = ctx.createAnalyser();
                analyzer.fftSize = 32;
                src.connect(analyzer);
                const data = new Uint8Array(analyzer.frequencyBinCount);
                
                const loop = () => {
                    const el = document.getElementById('user-'+id);
                    if(!el) return;
                    analyzer.getByteFrequencyData(data);
                    const vol = data.reduce((a,b)=>a+b)/data.length;
                    
                    const img = el.querySelector('.avatar');
                    if(vol > 15) img.classList.add('talking');
                    else img.classList.remove('talking');
                    requestAnimationFrame(loop);
                };
                loop();
            } catch(e) {
                log('–û—à–∏–±–∫–∞ –∞—É–¥–∏–æ-–∞–Ω–∞–ª–∏–∑–∞—Ç–æ—Ä–∞ (–Ω–µ –∫—Ä–∏—Ç–∏—á–Ω–æ)');
            }
        }
    </script>
</body>
</html>
