<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 64 64'><ellipse cx='32' cy='32' rx='28' ry='30' fill='%23000'/><ellipse cx='32' cy='37' rx='14' ry='16' fill='%23000'/><ellipse cx='24' cy='28' rx='4' ry='6' fill='%23fff'/><ellipse cx='40' cy='28' rx='4' ry='6' fill='%23fff'/></svg>">
    <title>–ü–ò–¢–ë–£–õ–¨–ß–ò–ö–ò: 5/0</title>
    <script src="https://unpkg.com/mqtt@4.3.7/dist/mqtt.min.js"></script>
    
    <style>
        :root {
            --glass-bg: rgba(255, 255, 255, 0.03);
            --glass-border: rgba(255, 255, 255, 0.1);
            --text-main: #ffffff;
            --primary-gradient: linear-gradient(135deg, #00C6FB 0%, #005BEA 100%);
            --danger-gradient: linear-gradient(135deg, #FF416C 0%, #FF4B2B 100%);
            --success-color: #00f260;
            --radius-lg: 24px;
            --radius-sm: 12px;
            --font-stack: -apple-system, BlinkMacSystemFont, Roboto, sans-serif;
        }

        body, html { 
            margin: 0; padding: 0; height: 100%; 
            font-family: var(--font-stack);
            color: var(--text-main);
            overflow: hidden;
            background: #0f0c29;
            background: linear-gradient(-45deg, #0f0c29, #302b63, #24243e);
            background-size: 400% 400%;
            animation: gradientShift 30s ease infinite; 
        }

        @keyframes gradientShift { 0% { background-position: 0% 50%; } 50% { background-position: 100% 50%; } 100% { background-position: 0% 50%; } }

        * { box-sizing: border-box; outline: none; -webkit-tap-highlight-color: transparent; }
        .hidden { display: none !important; }

        /* --- UI --- */
        #login-screen { display: flex; height: 100vh; align-items: center; justify-content: center; z-index: 10; position: relative; }
        .login-card { width: 100%; max-width: 380px; padding: 40px; border-radius: var(--radius-lg); text-align: center; background: rgba(20, 20, 30, 0.6); border: 1px solid rgba(255,255,255,0.1); backdrop-filter: blur(40px); }
        .btn-discord { background: var(--primary-gradient); color: white; border: none; width: 100%; padding: 14px; border-radius: var(--radius-sm); font-weight: 600; cursor: pointer; transition: 0.3s; margin-top: 10px; }
        .btn-discord:hover { filter: brightness(1.1); }
        input.discord-input { background: rgba(0,0,0,0.3); border: 1px solid rgba(255,255,255,0.1); padding: 14px; color: white; width: 100%; border-radius: var(--radius-sm); text-align: center; margin-bottom: 20px; }

        #app-layout { display: flex; height: 100vh; width: 100%; padding: 20px; gap: 20px; position: relative; z-index: 5; }
        .stage-area { flex: 1; display: flex; flex-direction: column; border-radius: var(--radius-lg); background: rgba(255, 255, 255, 0.03); border: 1px solid var(--glass-border); backdrop-filter: blur(20px); overflow: hidden; position: relative; }
        .stage-grid { flex: 1; padding: 20px; overflow-y: auto; display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); grid-auto-rows: 200px; gap: 20px; }

        .voice-card { background: rgba(0,0,0,0.2); border-radius: var(--radius-lg); display: flex; flex-direction: column; align-items: center; justify-content: center; position: relative; border: 1px solid rgba(255,255,255,0.05); transition: 0.3s; }
        .voice-card.speaking { border-color: var(--success-color); box-shadow: 0 0 20px rgba(0, 242, 96, 0.2); }
        .card-avatar { width: 80px; height: 80px; border-radius: 50%; background-size: cover; background-color: #000; margin-bottom: 15px; }
        .card-name { font-weight: 600; font-size: 14px; }

        /* GATE INDICATOR */
        .gate-status {
            position: absolute; top: 15px; right: 15px; width: 10px; height: 10px; border-radius: 50%;
            background: #333; transition: 0.1s; box-shadow: 0 0 5px #000;
        }
        .gate-status.open { background: var(--success-color); box-shadow: 0 0 10px var(--success-color); }
        .gate-label { position: absolute; top: 12px; right: 32px; font-size: 10px; opacity: 0.5; text-transform: uppercase; }

        .bottom-controls { position: absolute; bottom: 30px; left: 50%; transform: translateX(-50%); display: flex; gap: 15px; background: rgba(0,0,0,0.6); padding: 10px 20px; border-radius: 40px; backdrop-filter: blur(10px); z-index: 100; }
        .control-btn { width: 50px; height: 50px; border-radius: 50%; border: none; cursor: pointer; font-size: 20px; display: flex; align-items: center; justify-content: center; transition: 0.2s; background: rgba(255,255,255,0.1); color: white; }
        .control-btn:hover { background: rgba(255,255,255,0.2); }
        .control-btn.active { background: white; color: black; }
        .control-btn.leave { background: var(--danger-gradient); color: white; }

        .chat-panel { width: 300px; background: rgba(0,0,0,0.2); border-radius: var(--radius-lg); border: 1px solid var(--glass-border); display: flex; flex-direction: column; }
        #messages { flex: 1; padding: 20px; overflow-y: auto; display: flex; flex-direction: column; gap: 10px; }
        .msg { background: rgba(255,255,255,0.05); padding: 8px 12px; border-radius: 12px; font-size: 13px; color: #ddd; word-break: break-word; }
        .chat-input { background: transparent; border: none; padding: 15px; color: white; border-top: 1px solid rgba(255,255,255,0.1); outline: none; }

        @media (max-width: 800px) { #app-layout { flex-direction: column; } .chat-panel { width: 100%; height: 200px; } }
    </style>
</head>
<body>

    <div id="login-screen">
        <div class="login-card">
            <h2>–ü–ò–¢–ë–£–õ–¨–ß–ò–ö–ò</h2>
            <input type="text" id="username-in" class="discord-input" placeholder="–í–∞—à–µ –∏–º—è">
            <button class="btn-discord" onclick="app.join()">–í–û–ô–¢–ò –í –≠–§–ò–†</button>
        </div>
    </div>

    <div id="app-layout" class="hidden">
        <div class="stage-area">
            <div id="grid-users" class="stage-grid"></div>
            <div class="bottom-controls">
                <button class="control-btn active" id="btn-mic" onclick="app.toggleMic()">üé§</button>
                <button class="control-btn leave" onclick="app.logout()">üö™</button>
            </div>
        </div>
        <div class="chat-panel">
            <div id="messages"></div>
            <input type="text" id="msg-in" class="chat-input" placeholder="–ß–∞—Ç...">
        </div>
    </div>

<script>
const MQTT_BROKER = 'wss://broker.emqx.io:8084/mqtt';
const ROOM_ID = 'pitbull-studio-v4';
const ICE_SERVERS = { iceServers: [ { urls: 'stun:stun.l.google.com:19302' } ] };

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// üéõÔ∏è STUDIO PROCESSOR (WORKLET)
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

const WORKLET_CODE = `
class StudioGateProcessor extends AudioWorkletProcessor {
    constructor() {
        super();
        // –ù–ê–°–¢–†–û–ô–ö–ò "–ó–õ–û–ì–û" –ì–ï–ô–¢–ê
        this.openThreshold = -45;  // –ì–æ–ª–æ—Å –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –≥—Ä–æ–º—á–µ —ç—Ç–æ–≥–æ, —á—Ç–æ–±—ã –æ—Ç–∫—Ä—ã—Ç—å—Å—è
        this.closeThreshold = -55; // –ï—Å–ª–∏ —Ç–∏—à–µ —ç—Ç–æ–≥–æ - –º–æ–º–µ–Ω—Ç–∞–ª—å–Ω–æ –∑–∞–∫—Ä—ã–≤–∞–µ–º
        this.attack = 0.005;       // –°–∫–æ—Ä–æ—Å—Ç—å –æ—Ç–∫—Ä—ã—Ç–∏—è (–º–≥–Ω–æ–≤–µ–Ω–Ω–æ)
        this.release = 0.15;       // –°–∫–æ—Ä–æ—Å—Ç—å –∑–∞–∫—Ä—ã—Ç–∏—è (–ø–ª–∞–≤–Ω–æ, —á—Ç–æ–±—ã –Ω–µ "—Å—ä–µ–ª–æ" –æ–∫–æ–Ω—á–∞–Ω–∏–µ —Å–ª–æ–≤)
        
        this.envelope = 0;
        this.isOpen = false;
        this.holdTimer = 0;
        this.holdTime = 0.2; // –î–µ—Ä–∂–∞—Ç—å 200–º—Å –æ—Ç–∫—Ä—ã—Ç—ã–º –ø–æ—Å–ª–µ —Ñ—Ä–∞–∑—ã
    }

    process(inputs, outputs, parameters) {
        const input = inputs[0];
        const output = outputs[0];
        if (!input || !input[0] || !output) return true;

        let isGateOpenCurrentFrame = false;

        for (let i = 0; i < input[0].length; i++) {
            const sample = input[0][i];
            const power = Math.abs(sample);
            const db = 20 * Math.log10(power + 1e-6);

            // –õ–æ–≥–∏–∫–∞ –≤–æ—Ä–æ—Ç
            if (this.isOpen) {
                if (db < this.closeThreshold) {
                    // –ï—Å–ª–∏ —Å—Ç–∞–ª–æ —Ç–∏—Ö–æ
                    if (this.holdTimer > 0) {
                        this.holdTimer -= 1 / sampleRate;
                    } else {
                        this.isOpen = false;
                    }
                } else {
                    // –ï—Å–ª–∏ –≥–æ–≤–æ—Ä–∏–º - —Å–±—Ä–∞—Å—ã–≤–∞–µ–º —Ç–∞–π–º–µ—Ä —É–¥–µ—Ä–∂–∞–Ω–∏—è
                    this.holdTimer = this.holdTime;
                }
            } else {
                if (db > this.openThreshold) {
                    this.isOpen = true;
                    this.holdTimer = this.holdTime;
                }
            }

            // –ü–ª–∞–≤–Ω–æ–µ –æ—Ç–∫—Ä—ã—Ç–∏–µ/–∑–∞–∫—Ä—ã—Ç–∏–µ –≥—Ä–æ–º–∫–æ—Å—Ç–∏
            const targetGain = this.isOpen ? 1.0 : 0.0;
            const rate = this.isOpen ? this.attack : this.release;
            this.envelope += (targetGain - this.envelope) * rate;

            // –ü—Ä–∏–º–µ–Ω—è–µ–º –≥—Ä–æ–º–∫–æ—Å—Ç—å –∫ —Å—ç–º–ø–ª—É
            output[0][i] = sample * this.envelope;
            if(this.isOpen) isGateOpenCurrentFrame = true;
        }

        // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –≥–µ–π—Ç–∞ –≤ –æ—Å–Ω–æ–≤–Ω–æ–π –ø–æ—Ç–æ–∫ (–¥–ª—è –ª–∞–º–ø–æ—á–∫–∏)
        if (currentTime % 0.1 < 0.01) {
            this.port.postMessage({isOpen: this.envelope > 0.1});
        }
        
        return true;
    }
}
registerProcessor('studio-gate', StudioGateProcessor);
`;

const STUDIO_CONSTRAINTS = {
    audio: {
        echoCancellation: { ideal: true },
        noiseSuppression: { ideal: true },
        autoGainControl: { ideal: true },
        googEchoCancellation: { ideal: true },
        googNoiseSuppression: { ideal: true },
        googHighpassFilter: { ideal: true },
        channelCount: 1,
        sampleRate: 48000
    },
    video: false
};

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// üé§ –¶–ï–ü–û–ß–ö–ê –û–ë–†–ê–ë–û–¢–ö–ò (CHAIN)
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

async function setupStudioChain(stream) {
    const ctx = new AudioContext({ sampleRate: 48000 });
    await ctx.resume();

    // –ó–∞–≥—Ä—É–∂–∞–µ–º Worklet
    const blob = new Blob([WORKLET_CODE], { type: 'application/javascript' });
    await ctx.audioWorklet.addModule(URL.createObjectURL(blob));

    const source = ctx.createMediaStreamSource(stream);

    // 1. HPF (High Pass Filter) - –†–µ–∂–µ–º –Ω–∏–∑–∫–∏–π –≥—É–ª (–∫–æ–Ω–¥–∏—Ü–∏–æ–Ω–µ—Ä, –∫—É–ª–µ—Ä—ã)
    const lowCut = ctx.createBiquadFilter();
    lowCut.type = 'highpass';
    lowCut.frequency.value = 110; 
    lowCut.Q.value = 0.7;

    // 2. LPF (Low Pass Filter) - –†–µ–∂–µ–º —É–ª—å—Ç—Ä–∞-–≤—ã—Å–æ–∫–∏–π —à—É–º
    const highCut = ctx.createBiquadFilter();
    highCut.type = 'lowpass';
    highCut.frequency.value = 9000;

    // 3. Notch - –í—ã—Ä–µ–∑–∞–µ–º "—Ü–æ–∫–∞–Ω—å–µ" –º–µ—Ö–∞–Ω–∏–∫–∏ (–æ–±—ã—á–Ω–æ –æ–∫–æ–ª–æ 1.5–∫–ì—Ü - 2–∫–ì—Ü)
    const notch = ctx.createBiquadFilter();
    notch.type = 'peaking';
    notch.frequency.value = 1800;
    notch.Q.value = 1;
    notch.gain.value = -3; // –ß—É—Ç—å –ø—Ä–∏–≥–ª—É—à–∞–µ–º

    // 4. Presence - –î–µ–ª–∞–µ–º –≥–æ–ª–æ—Å "—á–µ—Ç–∫–∏–º"
    const presence = ctx.createBiquadFilter();
    presence.type = 'peaking';
    presence.frequency.value = 4000;
    presence.Q.value = 0.8;
    presence.gain.value = 3; 

    // 5. GATE - –ù–∞—à–∏ "—É–º–Ω—ã–µ –≤–æ—Ä–æ—Ç–∞"
    const gate = new AudioWorkletNode(ctx, 'studio-gate');
    
    // –°–ª—É—à–∞–µ–º –≥–µ–π—Ç –¥–ª—è –≤–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏–∏
    gate.port.onmessage = (e) => {
        const indicator = document.getElementById('my-gate-indicator');
        if(indicator) {
            if(e.data.isOpen) indicator.classList.add('open');
            else indicator.classList.remove('open');
        }
    };

    // 6. Compressor - –§–∏–Ω–∞–ª—å–Ω–∞—è –ø–æ–ª–∏—Ä–æ–≤–∫–∞ –≥—Ä–æ–º–∫–æ—Å—Ç–∏
    const comp = ctx.createDynamicsCompressor();
    comp.threshold.value = -20;
    comp.knee.value = 30;
    comp.ratio.value = 12;
    comp.release.value = 0.25;

    const dest = ctx.createMediaStreamDestination();

    // –°–æ–µ–¥–∏–Ω—è–µ–º
    source
        .connect(lowCut)
        .connect(highCut)
        .connect(notch)
        .connect(gate)      // –ì–µ–π—Ç —Å—Ç–æ–∏—Ç —Ç—É—Ç
        .connect(presence)
        .connect(comp)
        .connect(dest);

    return dest.stream;
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// üöÄ MAIN APP
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

class App {
    constructor() {
        this.client = null;
        this.peers = {};
        this.users = {};
        this.myId = 'u_' + Math.random().toString(36).substr(2, 6);
        this.myStream = null;
        this.myName = '';
    }

    async join() {
        this.myName = document.getElementById('username-in').value || 'User';
        document.getElementById('login-screen').classList.add('hidden');
        document.getElementById('app-layout').classList.remove('hidden');

        try {
            const rawStream = await navigator.mediaDevices.getUserMedia(STUDIO_CONSTRAINTS);
            this.myStream = await setupStudioChain(rawStream); // –í–∫–ª—é—á–∞–µ–º "–°—Ç—É–¥–∏—é"
            this.renderMyCard();
            this.connectMQTT();
        } catch(e) {
            alert('–û—à–∏–±–∫–∞ –º–∏–∫—Ä–æ—Ñ–æ–Ω–∞! ' + e.message);
        }
        
        document.getElementById('msg-in').addEventListener('keydown', e => { if(e.key==='Enter') this.sendMsg(); });
    }

    renderMyCard() {
        const grid = document.getElementById('grid-users');
        const div = document.createElement('div');
        div.className = 'voice-card';
        div.id = 'my-card';
        div.innerHTML = `
            <div class="gate-label">NOISE GATE</div>
            <div id="my-gate-indicator" class="gate-status"></div>
            <div class="card-avatar" style="background-image: url('https://cdn.discordapp.com/embed/avatars/0.png')"></div>
            <div class="card-name">${this.myName} (–í—ã)</div>
        `;
        grid.appendChild(div);
    }

    renderRemoteCard(uid, name) {
        if(document.getElementById('u-'+uid)) return;
        const grid = document.getElementById('grid-users');
        const div = document.createElement('div');
        div.className = 'voice-card';
        div.id = 'u-'+uid;
        div.innerHTML = `
            <div class="card-avatar" style="background-image: url('https://cdn.discordapp.com/embed/avatars/1.png')"></div>
            <div class="card-name">${name}</div>
        `;
        grid.appendChild(div);
    }

    connectMQTT() {
        this.client = mqtt.connect(MQTT_BROKER, { clientId: this.myId });
        this.client.on('connect', () => {
            this.client.subscribe(ROOM_ID + '/#');
            this.announce();
            setInterval(() => this.announce(), 3000);
        });
        this.client.on('message', (topic, msg) => {
            const d = JSON.parse(msg.toString());
            if(d.id === this.myId) return;

            if(topic.includes('presence')) {
                this.users[d.id] = d.name;
                this.renderRemoteCard(d.id, d.name);
                if(!this.peers[d.id] && this.myId > d.id) this.call(d.id);
            }
            else if(topic.includes('signal')) {
                if(d.target === this.myId) this.handleSignal(d);
            }
            else if(topic.includes('chat')) {
                this.addMsg(d.name, d.text);
            }
        });
    }

    announce() {
        this.client.publish(ROOM_ID + '/presence', JSON.stringify({ id: this.myId, name: this.myName }));
    }

    // WebRTC Logic
    call(targetId) {
        const pc = new RTCPeerConnection(ICE_SERVERS);
        this.peers[targetId] = pc;
        this.myStream.getTracks().forEach(t => pc.addTrack(t, this.myStream));
        
        pc.onicecandidate = e => {
            if(e.candidate) this.sig(targetId, 'candidate', e.candidate);
        };
        pc.ontrack = e => {
            const aud = new Audio();
            aud.srcObject = e.streams[0];
            aud.autoplay = true;
            document.body.appendChild(aud); // –í–∞–∂–Ω–æ –¥–ª—è –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏—è
            
            // –í–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏—è "–≥–æ–≤–æ—Ä–µ–Ω–∏—è" –¥–ª—è —É–¥–∞–ª–µ–Ω–Ω–æ–≥–æ —é–∑–µ—Ä–∞
            const ctx = new AudioContext();
            const src = ctx.createMediaStreamSource(e.streams[0]);
            const anl = ctx.createAnalyser();
            src.connect(anl);
            const data = new Uint8Array(anl.frequencyBinCount);
            const check = () => {
                anl.getByteFrequencyData(data);
                const vol = data.reduce((a,b)=>a+b)/data.length;
                const card = document.getElementById('u-'+targetId);
                if(card) {
                    if(vol > 10) card.classList.add('speaking');
                    else card.classList.remove('speaking');
                }
                requestAnimationFrame(check);
            };
            check();
        };

        pc.createOffer().then(o => pc.setLocalDescription(o)).then(() => {
            this.sig(targetId, 'sdp', pc.localDescription);
        });
    }

    async handleSignal(d) {
        let pc = this.peers[d.sender];
        if(!pc) {
            pc = new RTCPeerConnection(ICE_SERVERS);
            this.peers[d.sender] = pc;
            this.myStream.getTracks().forEach(t => pc.addTrack(t, this.myStream));
            pc.onicecandidate = e => { if(e.candidate) this.sig(d.sender, 'candidate', e.candidate); };
            pc.ontrack = e => {
                const aud = new Audio();
                aud.srcObject = e.streams[0];
                aud.autoplay = true;
                document.body.appendChild(aud);
            };
        }

        if(d.type === 'sdp') {
            await pc.setRemoteDescription(new RTCSessionDescription(d.data));
            if(d.data.type === 'offer') {
                const ans = await pc.createAnswer();
                await pc.setLocalDescription(ans);
                this.sig(d.sender, 'sdp', ans);
            }
        } else if(d.type === 'candidate') {
            await pc.addIceCandidate(new RTCIceCandidate(d.data));
        }
    }

    sig(target, type, data) {
        this.client.publish(ROOM_ID + '/signal', JSON.stringify({ sender: this.myId, target, type, data }));
    }

    toggleMic() {
        const track = this.myStream.getAudioTracks()[0];
        track.enabled = !track.enabled;
        document.getElementById('btn-mic').classList.toggle('active');
        document.getElementById('btn-mic').textContent = track.enabled ? 'üé§' : 'üîá';
    }

    logout() { location.reload(); }

    sendMsg() {
        const inp = document.getElementById('msg-in');
        if(!inp.value) return;
        this.client.publish(ROOM_ID + '/chat', JSON.stringify({ name: this.myName, text: inp.value }));
        inp.value = '';
    }

    addMsg(name, text) {
        const div = document.createElement('div');
        div.className = 'msg';
        div.innerHTML = `<b>${name}:</b> ${text}`;
        document.getElementById('messages').appendChild(div);
        document.getElementById('messages').scrollTop = 99999;
    }
}

const app = new App();
</script>
</body>
</html>
