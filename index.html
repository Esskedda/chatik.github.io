<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NetLobby Pro</title>
    <script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>
    
    <style>
        :root {
            /* Palette: Zinc-like colors */
            --bg-app: #09090b;       /* Black-ish */
            --bg-sidebar: #18181b;   /* Dark Gray */
            --bg-element: #27272a;   /* Element Gray */
            --bg-hover: #3f3f46;     /* Lighter Gray */
            
            --border: #27272a;       /* Subtle border */
            --border-highlight: #52525b;
            
            --accent: #3b82f6;       /* Solid Blue */
            --accent-hover: #2563eb;
            
            --text-main: #f4f4f5;
            --text-muted: #a1a1aa;
            
            --success: #10b981;
            --danger: #ef4444;
        }

        * { box-sizing: border-box; outline: none; }
        
        body, html { 
            margin: 0; padding: 0; height: 100%; 
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background: var(--bg-app);
            color: var(--text-main);
            overflow: hidden;
            -webkit-font-smoothing: antialiased;
        }

        .hidden { display: none !important; }

        /* --- UI COMPONENTS --- */
        .btn {
            background: var(--text-main); color: var(--bg-app);
            border: none; padding: 10px 20px; border-radius: 6px;
            font-weight: 600; font-size: 0.9rem; cursor: pointer;
            transition: all 0.2s;
        }
        .btn:hover { background: #e4e4e7; transform: translateY(-1px); }
        .btn-primary { background: var(--accent); color: white; }
        .btn-primary:hover { background: var(--accent-hover); }

        input[type="text"] {
            background: var(--bg-app); border: 1px solid var(--border-highlight);
            color: white; padding: 12px; border-radius: 6px; font-size: 0.95rem;
            transition: border 0.2s;
        }
        input[type="text"]:focus { border-color: var(--accent); }

        /* --- LOGIN SCREEN --- */
        #login-screen {
            display: flex; height: 100vh; align-items: center; justify-content: center;
            background: var(--bg-app);
        }
        .login-card {
            width: 320px; padding: 30px; 
            border: 1px solid var(--border); border-radius: 12px;
            background: var(--bg-sidebar);
            display: flex; flex-direction: column; gap: 15px;
        }
        .avatar-uploader {
            width: 80px; height: 80px; margin: 0 auto 10px;
            border-radius: 50%; background-color: var(--bg-element);
            background-size: cover; background-position: center;
            cursor: pointer; border: 2px solid var(--border);
            transition: border-color 0.2s;
        }
        .avatar-uploader:hover { border-color: var(--accent); }
        
        /* --- APP LAYOUT --- */
        #app-screen { display: flex; height: 100vh; }

        /* SIDEBAR */
        #sidebar {
            width: 260px; background: var(--bg-sidebar);
            border-right: 1px solid var(--border);
            display: flex; flex-direction: column;
        }
        .sidebar-header {
            height: 60px; display: flex; align-items: center; justify-content: space-between;
            padding: 0 16px; border-bottom: 1px solid var(--border);
            font-weight: 700; font-size: 0.95rem; letter-spacing: 0.5px;
        }
        .logout-link { font-size: 0.75rem; color: var(--text-muted); cursor: pointer; text-decoration: underline; }

        #user-list { flex: 1; overflow-y: auto; padding: 12px; }
        .user-item {
            display: flex; align-items: center; padding: 8px 10px;
            border-radius: 6px; margin-bottom: 4px; cursor: default;
        }
        .user-item:hover { background: var(--bg-element); }
        .u-avatar {
            width: 32px; height: 32px; border-radius: 6px; /* Squircle */
            background-color: var(--bg-element); background-size: cover;
            margin-right: 10px; position: relative;
            border: 2px solid transparent; transition: border-color 0.1s;
        }
        
        /* VAD: Green Border when speaking */
        .is-speaking .u-avatar { border-color: var(--success); }

        .u-name { font-size: 0.9rem; font-weight: 500; }
        .u-status { width: 8px; height: 8px; border-radius: 50%; background: var(--success); margin-left: auto; }

        /* VOICE CONTROLS (Fixed bottom) */
        .voice-controls {
            padding: 16px; border-top: 1px solid var(--border);
            background: var(--bg-sidebar);
            display: flex; align-items: center; justify-content: space-between;
        }
        .mic-btn {
            width: 100%; padding: 10px; border-radius: 6px; border: 1px solid var(--border);
            background: var(--bg-element); color: var(--text-main); font-weight: 600;
            cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 8px;
        }
        .mic-btn:hover { background: var(--bg-hover); }
        .mic-btn.active { background: rgba(16, 185, 129, 0.1); border-color: var(--success); color: var(--success); }
        .mic-btn.muted { background: rgba(239, 68, 68, 0.1); border-color: var(--danger); color: var(--danger); }

        /* CHAT AREA */
        #chat-area { flex: 1; display: flex; flex-direction: column; background: var(--bg-app); position: relative; }
        
        #messages {
            flex: 1; overflow-y: auto; padding: 20px 20px 0 20px;
            display: flex; flex-direction: column; gap: 4px; /* Tight grouping like Discord */
        }
        
        .msg { display: flex; margin-bottom: 12px; }
        .msg:hover { background: rgba(255,255,255,0.02); margin: -4px -20px 12px -20px; padding: 4px 20px; } /* Hover effect like Discord */
        
        .msg-left { width: 40px; margin-right: 12px; flex-shrink: 0; }
        .msg-ava { width: 40px; height: 40px; border-radius: 50%; background-size: cover; background-color: var(--bg-element); }
        
        .msg-right { flex: 1; min-width: 0; }
        .msg-header { display: flex; align-items: baseline; gap: 8px; margin-bottom: 2px; }
        .msg-name { font-weight: 600; font-size: 0.95rem; color: white; }
        .msg-time { font-size: 0.75rem; color: var(--text-muted); }
        .msg-content { color: #dcddde; line-height: 1.5; font-size: 0.95rem; word-wrap: break-word; }

        /* INPUT AREA */
        .input-area { padding: 20px; }
        .input-wrapper {
            background: var(--bg-element); border-radius: 8px;
            padding: 0 16px; display: flex; align-items: center;
        }
        #chat-input {
            width: 100%; border: none; background: transparent;
            padding: 14px 0; color: var(--text-main); font-size: 0.95rem;
        }
        #chat-input:focus { border: none; }

        /* Diagnostics */
        #diag { position: absolute; top: 10px; right: 10px; font-family: monospace; font-size: 10px; color: var(--bg-hover); pointer-events: none; }

        /* Scrollbar */
        ::-webkit-scrollbar { width: 10px; background: var(--bg-sidebar); }
        ::-webkit-scrollbar-thumb { background: var(--bg-element); border-radius: 5px; border: 2px solid var(--bg-sidebar); }
    </style>
</head>
<body>

    <!-- LOGIN -->
    <div id="login-screen">
        <div class="login-card">
            <h2 style="margin: 0; font-size: 1.2rem; text-align: center;">NetLobby <span style="color:var(--text-muted)">Pro</span></h2>
            <div id="avatar-preview" class="avatar-uploader" onclick="document.getElementById('avatar-upload').click()"></div>
            <input type="file" id="avatar-upload" accept="image/*" style="display:none">
            
            <input type="text" id="username-input" placeholder="Display Name" maxlength="20">
            <button class="btn btn-primary" onclick="app.manualJoin()">Connect</button>
        </div>
    </div>

    <!-- APP -->
    <div id="app-screen" class="hidden">
        <!-- Sidebar -->
        <div id="sidebar">
            <div class="sidebar-header">
                <span>ROOM #1</span>
                <span class="logout-link" onclick="app.logout()">Disconnect</span>
            </div>
            
            <div id="user-list">
                <!-- Users -->
            </div>

            <div class="voice-controls">
                <button id="mic-btn" class="mic-btn muted" onclick="app.toggleMic()">
                    <span id="mic-icon">✕</span>
                    <span id="mic-text">Mic Off</span>
                </button>
            </div>
        </div>

        <!-- Chat -->
        <div id="chat-area">
            <div id="diag">STATUS: OK</div>
            <div id="messages"></div>
            
            <div class="input-area">
                <div class="input-wrapper">
                    <input type="text" id="chat-input" placeholder="Message #general" autocomplete="off">
                </div>
            </div>
        </div>
    </div>

<script>
// --- CONFIG (Тот же самый конфиг) ---
const MQTT_BROKER = 'wss://broker.emqx.io:8084/mqtt';
const ROOM_ID = 'neon-lobby-v3-pro'; 
const ICE_SERVERS = {
    iceServers: [
        { urls: 'stun:stun.l.google.com:19302' },
        { urls: 'stun:stun1.l.google.com:19302' }
    ]
};

// --- LOGIC (Тот же самый JS класс, только методы рендера UI обновлены под новые классы) ---
class NetLobby {
    constructor() {
        this.client = null;
        this.localStream = null;
        this.peers = {}; 
        this.users = {}; 
        this.myId = 'u_' + Math.random().toString(36).substr(2, 9);
        this.myProfile = { name: '', avatar: '' };
        this.audioContext = null;
        this.isMuted = true;
        
        this.topicPresence = `${ROOM_ID}/presence`;
        this.topicSignal = `${ROOM_ID}/signal/${this.myId}`;
        this.topicChat = `${ROOM_ID}/chat`;
    }

    init() {
        const sessionActive = localStorage.getItem('nl_session_active');
        const savedName = localStorage.getItem('nl_name');
        const savedAvatar = localStorage.getItem('nl_avatar');
        
        // Default Avatar - Abstract Gradient
        const defAvatar = 'https://ui-avatars.com/api/?background=27272a&color=fff&name=User';

        if (savedAvatar) {
            this.myProfile.avatar = savedAvatar;
            document.getElementById('avatar-preview').style.backgroundImage = `url(${savedAvatar})`;
        } else {
            this.myProfile.avatar = defAvatar;
            document.getElementById('avatar-preview').style.backgroundImage = `url(${defAvatar})`;
        }

        if (savedName) document.getElementById('username-input').value = savedName;

        document.getElementById('avatar-upload').addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = (ev) => {
                this.myProfile.avatar = ev.target.result;
                document.getElementById('avatar-preview').style.backgroundImage = `url(${this.myProfile.avatar})`;
            };
            reader.readAsDataURL(file);
        });

        document.getElementById('chat-input').addEventListener('keydown', (e) => {
            if(e.key === 'Enter') this.sendMessage();
        });

        if (sessionActive === 'true' && savedName) {
            this.join(savedName);
        }
    }

    manualJoin() {
        const name = document.getElementById('username-input').value.trim();
        if (!name) return alert("Enter name");
        this.join(name);
    }

    async join(name) {
        this.myProfile.name = name;
        localStorage.setItem('nl_name', name);
        localStorage.setItem('nl_avatar', this.myProfile.avatar);
        localStorage.setItem('nl_session_active', 'true');

        document.getElementById('login-screen').classList.add('hidden');
        document.getElementById('app-screen').classList.remove('hidden');

        try {
            this.localStream = await navigator.mediaDevices.getUserMedia({ audio: true, video: false });
            this.localStream.getAudioTracks()[0].enabled = false; 
            this.setupVAD(this.localStream, this.myId);
        } catch (e) { console.warn("Mic error:", e); }

        this.connectMQTT();
    }

    logout() {
        localStorage.removeItem('nl_session_active');
        location.reload();
    }

    // --- MQTT & WebRTC (Standard logic) ---
    connectMQTT() {
        this.client = mqtt.connect(MQTT_BROKER);
        this.client.on('connect', () => {
            document.getElementById('diag').textContent = "CONNECTED";
            document.getElementById('diag').style.color = "var(--success)";
            
            this.client.subscribe(this.topicPresence);
            this.client.subscribe(`${ROOM_ID}/signal/${this.myId}`);
            this.client.subscribe(this.topicChat);

            this.announce();
            setInterval(() => this.announce(), 5000);
        });

        this.client.on('message', (topic, msg) => {
            const data = JSON.parse(msg.toString());
            if (topic === this.topicPresence) this.handlePresence(data);
            else if (topic === this.topicChat) this.renderMessage(data);
            else this.handleSignal(data);
        });
    }

    announce() {
        this.client.publish(this.topicPresence, JSON.stringify({ id: this.myId, user: this.myProfile }));
    }

    handlePresence(data) {
        if (data.id === this.myId) return;
        if (!this.users[data.id]) {
            this.users[data.id] = data.user;
            this.updateRoster();
            if (this.myId > data.id) this.createPeer(data.id, true);
        }
    }

    createPeer(targetId, initiator) {
        if (this.peers[targetId]) return;
        const pc = new RTCPeerConnection(ICE_SERVERS);
        if (this.localStream) this.localStream.getTracks().forEach(t => pc.addTrack(t, this.localStream));
        
        pc.onicecandidate = (e) => {
            if (e.candidate) this.sendSignal(targetId, { type: 'candidate', candidate: e.candidate });
        };
        pc.ontrack = (e) => {
            const audio = new Audio();
            audio.srcObject = e.streams[0];
            audio.autoplay = true;
            document.body.appendChild(audio);
            this.setupVAD(e.streams[0], targetId);
        };
        pc.oniceconnectionstatechange = () => {
            if(pc.iceConnectionState == 'disconnected') this.removePeer(targetId);
        };
        this.peers[targetId] = pc;
        if (initiator) {
            pc.createOffer().then(o => { pc.setLocalDescription(o); this.sendSignal(targetId, { type: 'sdp', sdp: o }); });
        }
    }

    async handleSignal(data) {
        if (!this.peers[data.senderId]) this.createPeer(data.senderId, false);
        const pc = this.peers[data.senderId];
        const sig = data.payload;
        if (sig.type === 'sdp') {
            await pc.setRemoteDescription(new RTCSessionDescription(sig.sdp));
            if (sig.sdp.type === 'offer') {
                const ans = await pc.createAnswer();
                await pc.setLocalDescription(ans);
                this.sendSignal(data.senderId, { type: 'sdp', sdp: ans });
            }
        } else if (sig.type === 'candidate') {
            try { await pc.addIceCandidate(new RTCIceCandidate(sig.candidate)); } catch(e){}
        }
    }

    sendSignal(targetId, payload) {
        this.client.publish(`${ROOM_ID}/signal/${targetId}`, JSON.stringify({ senderId: this.myId, payload }));
    }

    removePeer(id) {
        if(this.peers[id]) { this.peers[id].close(); delete this.peers[id]; }
        delete this.users[id];
        this.updateRoster();
    }

    // --- UI & VAD ---

    sendMessage() {
        const inp = document.getElementById('chat-input');
        const txt = inp.value.trim();
        if (!txt) return;
        this.client.publish(this.topicChat, JSON.stringify({
            id: this.myId, name: this.myProfile.name, avatar: this.myProfile.avatar, text: txt
        }));
        inp.value = '';
    }

    renderMessage(data) {
        const box = document.getElementById('messages');
        const div = document.createElement('div');
        div.className = 'msg';
        const safeText = data.text.replace(/</g, "&lt;");
        
        // Modern "Discord-like" Row
        div.innerHTML = `
            <div class="msg-left">
                <div class="msg-ava" style="background-image: url('${data.avatar}')"></div>
            </div>
            <div class="msg-right">
                <div class="msg-header">
                    <span class="msg-name">${data.name}</span>
                    <span class="msg-time">${new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}</span>
                </div>
                <div class="msg-content">${safeText}</div>
            </div>
        `;
        box.appendChild(div);
        box.scrollTop = box.scrollHeight;
    }

    updateRoster() {
        const list = document.getElementById('user-list');
        list.innerHTML = '';
        const render = (u, id, isMe) => {
            const div = document.createElement('div');
            div.className = 'user-item';
            div.setAttribute('data-uid', id);
            div.innerHTML = `
                <div class="u-avatar" style="background-image: url('${u.avatar}')"></div>
                <span class="u-name">${u.name} ${isMe ? '(You)' : ''}</span>
                <div class="u-status"></div>
            `;
            list.appendChild(div);
        };
        render(this.myProfile, this.myId, true);
        Object.keys(this.users).forEach(k => render(this.users[k], k, false));
    }

    setupVAD(stream, userId) {
        if (!this.audioContext) this.audioContext = new (window.AudioContext || window.webkitAudioContext)();
        if (this.audioContext.state === 'suspended') this.audioContext.resume();
        const src = this.audioContext.createMediaStreamSource(stream);
        const analyser = this.audioContext.createAnalyser();
        analyser.fftSize = 256;
        src.connect(analyser);
        const buffer = new Uint8Array(analyser.frequencyBinCount);

        const checkAudio = () => {
            analyser.getByteFrequencyData(buffer);
            let sum = 0; for(let val of buffer) sum += val;
            const vol = sum / buffer.length;
            const el = document.querySelector(`.user-item[data-uid="${userId}"]`);
            if (el) {
                if (vol > 10) el.classList.add('is-speaking');
                else el.classList.remove('is-speaking');
            }
            requestAnimationFrame(checkAudio);
        };
        checkAudio();
    }

    toggleMic() {
        if (!this.localStream) return;
        this.isMuted = !this.isMuted;
        this.localStream.getAudioTracks()[0].enabled = !this.isMuted;
        
        const btn = document.getElementById('mic-btn');
        const icon = document.getElementById('mic-icon');
        const txt = document.getElementById('mic-text');
        
        if (this.isMuted) {
            btn.className = 'mic-btn muted';
            icon.textContent = '✕';
            txt.textContent = 'Mic Off';
        } else {
            btn.className = 'mic-btn active';
            icon.textContent = '●';
            txt.textContent = 'Speaking...';
        }
    }
}

const app = new NetLobby();
app.init();
</script>
</body>
</html>
