<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Voice Room 2.0</title>
    <!-- –ò—Å–ø–æ–ª—å–∑—É–µ–º Trystero Torrent (—Å–∞–º—ã–π —Å—Ç–∞–±–∏–ª—å–Ω—ã–π –¥–ª—è P2P) -->
    <script src="https://unpkg.com/trystero@0.17.0/dist/trystero-torrent.min.js"></script>
    
    <style>
        :root { --bg: #202225; --dark: #2f3136; --accent: #5865f2; --text: #fff; }
        * { box-sizing: border-box; }
        body { margin: 0; background: var(--bg); color: var(--text); font-family: system-ui, -apple-system, sans-serif; height: 100vh; display: flex; flex-direction: column; }
        
        /* –≠–ö–†–ê–ù –í–•–û–î–ê */
        #login-screen { position: fixed; inset: 0; background: var(--bg); z-index: 999; display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 20px; }
        .login-box { width: 100%; max-width: 300px; display: flex; flex-direction: column; gap: 15px; }
        input { background: var(--dark); border: 1px solid #000; padding: 15px; color: white; border-radius: 5px; font-size: 16px; outline: none; }
        button { background: var(--accent); color: white; border: none; padding: 15px; border-radius: 5px; font-weight: bold; font-size: 16px; cursor: pointer; }
        button:active { opacity: 0.8; }

        /* –ò–ù–¢–ï–†–§–ï–ô–° */
        header { padding: 15px; background: var(--dark); border-bottom: 1px solid #000; display: flex; justify-content: space-between; align-items: center; }
        #status { font-size: 12px; color: #aaa; }
        
        #grid { flex: 1; padding: 20px; display: grid; grid-template-columns: repeat(auto-fill, minmax(100px, 1fr)); gap: 15px; align-content: start; overflow-y: auto; }
        
        .user { background: var(--dark); padding: 15px; border-radius: 10px; display: flex; flex-direction: column; align-items: center; position: relative; }
        .avatar { width: 60px; height: 60px; border-radius: 50%; background: #444; object-fit: cover; border: 3px solid transparent; transition: 0.2s; }
        .talking { border-color: #3ba55c; box-shadow: 0 0 10px #3ba55c; }
        .muted-icon { position: absolute; top: 10px; right: 10px; font-size: 14px; background: rgba(0,0,0,0.5); padding: 2px; border-radius: 50%; display: none; }
        .is-muted .muted-icon { display: block; }
        .name { margin-top: 10px; font-size: 13px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 100%; }

        /* –ü–ê–ù–ï–õ–¨ –£–ü–†–ê–í–õ–ï–ù–ò–Ø */
        .controls { padding: 20px; background: var(--dark); display: flex; justify-content: center; gap: 20px; border-top: 1px solid #000; padding-bottom: max(20px, env(safe-area-inset-bottom)); }
        .btn-circle { width: 60px; height: 60px; border-radius: 50%; border: none; background: #40444b; color: white; font-size: 24px; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: 0.2s; }
        .btn-circle.red { background: #ed4245; }
        .btn-circle.green { background: #3ba55c; }
    </style>
</head>
<body>

    <div id="login-screen">
        <h2 style="margin-bottom: 20px;">üîä –í—Ö–æ–¥ –≤ –∫–æ–º–Ω–∞—Ç—É</h2>
        <div class="login-box">
            <input type="text" id="key" placeholder="–ö–ª—é—á –∫–æ–º–Ω–∞—Ç—ã (–ø–∞—Ä–æ–ª—å)">
            <input type="text" id="nick" placeholder="–í–∞—à–µ –∏–º—è">
            <button onclick="join()">–ü–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è</button>
        </div>
        <p style="color:#777; font-size:12px; margin-top:20px; text-align:center;">
            –í—Å–µ, –∫—Ç–æ –≤–≤–µ–¥—É—Ç –æ–¥–∏–Ω –∫–ª—é—á,<br>–ø–æ–ø–∞–¥—É—Ç –≤ –æ–¥–Ω—É –≥–æ–ª–æ—Å–æ–≤—É—é —Å–≤—è–∑—å.
        </p>
    </div>

    <header>
        <div style="font-weight: bold;">Voice Chat</div>
        <div id="status">–û—Ñ—Ñ–ª–∞–π–Ω</div>
    </header>

    <div id="grid"></div>

    <div class="controls">
        <button id="mic-btn" class="btn-circle" onclick="toggleMic()">üé§</button>
        <button class="btn-circle red" onclick="location.reload()">üö™</button>
    </div>

    <script>
        let room, sendMeta, localStream;
        let myId = Math.random().toString(36).substr(2, 9);
        let peers = {};

        // –ù–∞—Å—Ç—Ä–æ–π–∫–∏ STUN (–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ –¥–ª—è –†–§)
        const rtcConfig = {
            iceServers: [
                { urls: 'stun:stun.l.google.com:19302' },
                { urls: 'stun:stun.sipnet.ru:3478' } // –†–æ—Å—Å–∏–π—Å–∫–∏–π —Å–µ—Ä–≤–µ—Ä
            ]
        };

        // –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö
        window.onload = () => {
            if(localStorage.getItem('vchat_key')) document.getElementById('key').value = localStorage.getItem('vchat_key');
            if(localStorage.getItem('vchat_nick')) document.getElementById('nick').value = localStorage.getItem('vchat_nick');
        };

        async function join() {
            const key = document.getElementById('key').value.trim();
            const nick = document.getElementById('nick').value.trim();
            
            if(!key || !nick) return alert('–í–≤–µ–¥–∏—Ç–µ –∫–ª—é—á –∏ –∏–º—è!');

            localStorage.setItem('vchat_key', key);
            localStorage.setItem('vchat_nick', nick);

            try {
                // 1. –ú–∏–∫—Ä–æ—Ñ–æ–Ω
                localStream = await navigator.mediaDevices.getUserMedia({ audio: true });
                document.getElementById('login-screen').style.display = 'none';

                // 2. –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è (–í–ê–ñ–ù–û: –ö–ª—é—á = AppID)
                // –ú—ã –∏—Å–ø–æ–ª—å–∑—É–µ–º –∫–ª—é—á –ø—Ä—è–º–æ –∫–∞–∫ ID –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è, —á—Ç–æ–±—ã —Å–æ–∑–¥–∞—Ç—å —É–Ω–∏–∫–∞–ª—å–Ω—É—é "–≤—Å–µ–ª–µ–Ω–Ω—É—é" –¥–ª—è –∫–æ–º–Ω–∞—Ç—ã
                const appId = 'vchat_ru_' + key.replace(/[^a-zA-Z0-9]/g, ''); 
                
                initRoom(appId, nick);
                
                // –†–µ–Ω–¥–µ—Ä —Å–µ–±—è
                renderUser(myId, nick, true);
                monitorAudio(localStream, myId);

            } catch(e) {
                alert('–û—à–∏–±–∫–∞ –º–∏–∫—Ä–æ—Ñ–æ–Ω–∞: ' + e.message);
            }
        }

        function initRoom(appId, nick) {
            document.getElementById('status').innerText = '–ü–æ–∏—Å–∫ –ø–∏—Ä–æ–≤...';
            
            // –ó–∞—Ö–æ–¥–∏–º –≤ "–ª–æ–±–±–∏" —Å —ç—Ç–∏–º ID
            room = Trystero.joinRoom({ appId: appId, rtcConfig }, 'lobby');

            // –û–±–º–µ–Ω –¥–∞–Ω–Ω—ã–º–∏ (–∏–º—è, —Å—Ç–∞—Ç—É—Å –º—É—Ç–∞)
            const [send, get] = room.makeAction('meta');
            sendMeta = send;

            // --- –°–û–ë–´–¢–ò–Ø ---
            
            room.onPeerJoin(id => {
                console.log('–ö—Ç–æ-—Ç–æ –∑–∞—à–µ–ª:', id);
                document.getElementById('status').innerText = '–ü–æ–¥–∫–ª—é—á–µ–Ω–æ';
                // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –Ω–æ–≤–∏—á–∫—É —Å–≤–æ–µ –∏–º—è –∏ —Å—Ç–∞—Ç—É—Å —Å—Ä–∞–∑—É
                send({ name: nick, muted: !localStream.getAudioTracks()[0].enabled }, id);
            });

            room.onPeerLeave(id => {
                document.getElementById('user-'+id)?.remove();
            });

            room.onPeerStream((stream, id) => {
                // –°–æ–∑–¥–∞–µ–º –∑–≤—É–∫
                const audio = new Audio();
                audio.srcObject = stream;
                audio.autoplay = true;
                audio.playsInline = true;
                document.body.appendChild(audio);

                // –ï—Å–ª–∏ —é–∑–µ—Ä–∞ –µ—â–µ –Ω–µ—Ç –≤ UI (–ø–æ—Ç–æ–∫ –ø—Ä–∏—à–µ–ª —Ä–∞–Ω—å—à–µ –∏–º–µ–Ω–∏)
                if(!document.getElementById('user-'+id)) {
                    renderUser(id, '–ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ...', false);
                }
                monitorAudio(stream, id);
            });

            get((data, id) => {
                // –û–±–Ω–æ–≤–ª—è–µ–º –∏–º—è –∏–ª–∏ —Å—Ç–∞—Ç—É—Å –º—É—Ç–∞
                if(!document.getElementById('user-'+id)) {
                    renderUser(id, data.name, false);
                }
                updateMuteStatus(id, data.muted);
                // –û–±–Ω–æ–≤–ª—è–µ–º –∏–º—è, –µ—Å–ª–∏ –ø—Ä–∏—à–ª–æ
                if(data.name) document.querySelector(`#user-${id} .name`).innerText = data.name;
            });

            // –î–æ–±–∞–≤–ª—è–µ–º —Å–≤–æ–π –ø–æ—Ç–æ–∫
            room.addStream(localStream);
        }

        // --- UI ---
        function renderUser(id, name, isLocal) {
            if(document.getElementById('user-'+id)) return;
            
            const div = document.createElement('div');
            div.id = 'user-'+id;
            div.className = 'user ' + (isLocal ? 'local' : '');
            
            // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º –∞–≤–∞—Ç–∞—Ä –ø–æ –∏–º–µ–Ω–∏
            const ava = `https://ui-avatars.com/api/?name=${name}&background=random&color=fff&bold=true`;
            
            div.innerHTML = `
                <div class="muted-icon">üîá</div>
                <img src="${ava}" class="avatar">
                <div class="name">${name} ${isLocal ? '(–í—ã)' : ''}</div>
            `;
            document.getElementById('grid').appendChild(div);
        }

        function toggleMic() {
            const track = localStream.getAudioTracks()[0];
            track.enabled = !track.enabled;
            
            const btn = document.getElementById('mic-btn');
            const myNode = document.getElementById('user-'+myId);
            
            if(track.enabled) {
                btn.classList.remove('red');
                btn.innerText = 'üé§';
                myNode.classList.remove('is-muted');
            } else {
                btn.classList.add('red');
                btn.innerText = 'üîá';
                myNode.classList.add('is-muted');
            }

            // –®–ª–µ–º –≤—Å–µ–º –Ω–æ–≤—ã–π —Å—Ç–∞—Ç—É—Å
            if(sendMeta) sendMeta({ muted: !track.enabled });
        }

        function updateMuteStatus(id, isMuted) {
            const node = document.getElementById('user-'+id);
            if(node) {
                if(isMuted) node.classList.add('is-muted');
                else node.classList.remove('is-muted');
            }
        }

        // –í–∏–∑—É–∞–ª–∏–∑–∞—Ç–æ—Ä
        function monitorAudio(stream, id) {
            const ctx = new (window.AudioContext || window.webkitAudioContext)();
            const src = ctx.createMediaStreamSource(stream);
            const analyzer = ctx.createAnalyser();
            analyzer.fftSize = 32;
            src.connect(analyzer);
            
            const data = new Uint8Array(analyzer.frequencyBinCount);
            
            const loop = () => {
                const node = document.getElementById('user-'+id);
                if(!node) return; // –Æ–∑–µ—Ä –≤—ã—à–µ–ª
                
                analyzer.getByteFrequencyData(data);
                // –°—Ä–µ–¥–Ω—è—è –≥—Ä–æ–º–∫–æ—Å—Ç—å
                const vol = data.reduce((a,b)=>a+b) / data.length;
                
                const ava = node.querySelector('.avatar');
                if(vol > 20) ava.classList.add('talking');
                else ava.classList.remove('talking');
                
                requestAnimationFrame(loop);
            };
            loop();
        }
    </script>
</body>
</html>
