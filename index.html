<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NetLobby (Serverless)</title>
    <!-- –ü–æ–¥–∫–ª—é—á–∞–µ–º MQTT –±–∏–±–ª–∏–æ—Ç–µ–∫—É –¥–ª—è —Å–∏–≥–Ω–∞–ª–∏–Ω–≥–∞ –±–µ–∑ —Å–≤–æ–µ–≥–æ —Å–µ—Ä–≤–µ—Ä–∞ -->
    <script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>
    <style>
        :root {
            --bg-dark: #202225;
            --bg-sidebar: #2f3136;
            --bg-chat: #36393f;
            --bg-input: #40444b;
            --text-main: #dcddde;
            --accent: #5865f2;
            --accent-hover: #4752c4;
            --red: #ed4245;
            --green: #3ba55c;
        }
        body, html { margin: 0; padding: 0; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: var(--bg-dark); color: var(--text-main); height: 100%; overflow: hidden; }
        
        .hidden { display: none !important; }
        .btn { padding: 10px 20px; border: none; border-radius: 4px; color: white; cursor: pointer; font-weight: bold; transition: 0.2s; }
        .btn-primary { background: var(--accent); }
        .btn-primary:hover { background: var(--accent-hover); }
        
        /* Login */
        #login-screen { display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100vh; background: var(--bg-dark); }
        .login-box { background: var(--bg-sidebar); padding: 30px; border-radius: 8px; width: 300px; box-shadow: 0 4px 15px rgba(0,0,0,0.3); text-align: center; }
        .login-box input { width: 100%; padding: 10px; margin: 10px 0; background: var(--bg-input); border: 1px solid #202225; color: white; border-radius: 4px; box-sizing: border-box; }
        .avatar-preview { width: 80px; height: 80px; border-radius: 50%; background: #555; margin: 0 auto 15px; background-size: cover; background-position: center; border: 2px solid var(--accent); }

        /* App */
        #app-screen { display: flex; height: 100vh; }
        #sidebar { width: 240px; background: var(--bg-sidebar); display: flex; flex-direction: column; border-right: 1px solid #202225; }
        .sidebar-header { padding: 15px; border-bottom: 1px solid #202225; font-weight: bold; font-size: 0.9em; text-transform: uppercase; color: #8e9297; }
        #user-list { flex: 1; overflow-y: auto; padding: 10px; }
        .user-item { display: flex; align-items: center; padding: 8px; border-radius: 4px; margin-bottom: 2px; }
        .user-item:hover { background: rgba(79,84,92,0.32); }
        .user-avatar { width: 32px; height: 32px; border-radius: 50%; margin-right: 10px; background-size: cover; background-color: #555; position: relative; }
        .user-name { font-size: 0.95em; color: white; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
        .speaking-indicator { border: 2px solid var(--green); box-shadow: 0 0 5px var(--green); }
        
        #chat-area { flex: 1; display: flex; flex-direction: column; background: var(--bg-chat); position: relative; }
        #messages { flex: 1; overflow-y: auto; padding: 20px; display: flex; flex-direction: column; gap: 10px; }
        .message { display: flex; align-items: flex-start; }
        .msg-avatar { width: 40px; height: 40px; border-radius: 50%; margin-right: 15px; background-size: cover; background-color: #555; flex-shrink: 0; }
        .msg-content { display: flex; flex-direction: column; }
        .msg-header { display: flex; align-items: baseline; margin-bottom: 2px; }
        .msg-author { font-weight: bold; color: white; margin-right: 8px; }
        .msg-time { font-size: 0.75em; color: #72767d; }
        .msg-text { color: #dcddde; word-break: break-word; line-height: 1.4; }
        
        .input-wrapper { padding: 20px; background: var(--bg-chat); }
        .input-box { background: var(--bg-input); border-radius: 8px; padding: 0 15px; display: flex; align-items: center; }
        #chat-input { background: transparent; border: none; color: white; padding: 15px 0; width: 100%; outline: none; font-size: 1em; }

        #voice-controls { height: 50px; background: #292b2f; display: flex; align-items: center; padding: 0 10px; justify-content: space-between; border-top: 1px solid #202225; }
        .vc-status { font-size: 0.8em; color: var(--green); font-weight: bold; }
        .vc-btn { background: transparent; border: none; color: white; cursor: pointer; padding: 5px; border-radius: 4px; }
        .vc-btn:hover { background: #3f4147; }
        .vc-btn.muted { color: var(--red); }

        #diagnostics { position: absolute; top: 0; right: 0; background: rgba(0,0,0,0.7); color: lime; font-family: monospace; font-size: 10px; padding: 5px; pointer-events: none; z-index: 1000; }
    </style>
</head>
<body>

    <div id="login-screen">
        <div class="login-box">
            <h2 style="color:white; margin-bottom: 20px;">NetLobby (GH Pages)</h2>
            <div id="avatar-preview" class="avatar-preview"></div>
            <input type="file" id="avatar-upload" accept="image/*" style="display:none">
            <button class="btn" style="background:#4f545c; font-size:0.8em; margin-bottom:10px;" onclick="document.getElementById('avatar-upload').click()">–í—ã–±—Ä–∞—Ç—å —Ñ–æ—Ç–æ</button>
            <input type="text" id="username-input" placeholder="–ù–∏–∫–Ω–µ–π–º" maxlength="20">
            <button class="btn btn-primary" style="width:100%" onclick="app.join()">–í–æ–π—Ç–∏</button>
        </div>
    </div>

    <div id="app-screen" class="hidden">
        <div id="sidebar">
            <div class="sidebar-header">–ö–æ–º–Ω–∞—Ç–∞ #Lobby</div>
            <div id="user-list"></div>
            <div id="voice-controls">
                <div style="display:flex; flex-direction:column;">
                    <span style="font-size:0.75em; color:#b9bbbe;">–ì–æ–ª–æ—Å</span>
                    <span id="connection-status" class="vc-status">–û–∂–∏–¥–∞–Ω–∏–µ...</span>
                </div>
                <button class="vc-btn" id="mic-btn" onclick="app.toggleMic()">üé§</button>
            </div>
        </div>
        <div id="chat-area">
            <div id="messages"></div>
            <div class="input-wrapper">
                <div class="input-box">
                    <input type="text" id="chat-input" placeholder="–ù–∞–ø–∏—Å–∞—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ..." onkeydown="if(event.key==='Enter') app.sendMessage()">
                </div>
            </div>
        </div>
    </div>

    <div id="diagnostics">
        MQTT: <span id="diag-mqtt">Connecting...</span><br>
        Peers: <span id="diag-peers">0</span>
    </div>

<script>
/**
 * –ù–ê–°–¢–†–û–ô–ö–ò
 * –ú—ã –∏—Å–ø–æ–ª—å–∑—É–µ–º –ø—É–±–ª–∏—á–Ω—ã–π MQTT –±—Ä–æ–∫–µ—Ä (EMQX) –≤–º–µ—Å—Ç–æ —Å–≤–æ–µ–≥–æ —Å–µ—Ä–≤–µ—Ä–∞.
 * ROOM_ID: —É–Ω–∏–∫–∞–ª—å–Ω—ã–π ID –∫–æ–º–Ω–∞—Ç—ã. –ß—Ç–æ–±—ã —Å–æ–∑–¥–∞—Ç—å "—Å–≤–æ—é" –ø—Ä–∏–≤–∞—Ç–Ω—É—é —Å–µ—Ç—å, 
 * –ø–æ–º–µ–Ω—è–π 'netlobby-public-ru-v1' –Ω–∞ —á—Ç–æ-—Ç–æ —É–Ω–∏–∫–∞–ª—å–Ω–æ–µ (–Ω–∞–ø—Ä. 'my-secret-room-55').
 */
const MQTT_BROKER = 'wss://broker.emqx.io:8084/mqtt'; // Secure WebSocket
const ROOM_ID = 'netlobby-public-ru-v1'; // <--- –ü–û–ú–ï–ù–Ø–ô –≠–¢–û –î–õ–Ø –ü–†–ò–í–ê–¢–ù–û–°–¢–ò

// –ö–æ–Ω—Ñ–∏–≥ WebRTC
const ICE_SERVERS = {
    iceServers: [
        { urls: 'stun:stun.l.google.com:19302' },
        // –ï—Å–ª–∏ –≥–æ–ª–æ—Å –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç –≤ –†–§, –Ω—É–∂–µ–Ω TURN. –ë–µ—Å–ø–ª–∞—Ç–Ω—ã–µ –ø—É–±–ª–∏—á–Ω—ã–µ TURN —Ä–µ–¥–∫–∏ –∏ –∂–∏–≤—É—Ç –Ω–µ–¥–æ–ª–≥–æ.
        // { urls: 'turn:openrelay.metered.ca:80', username: 'openrelayproject', credential: 'openrelayproject' } 
    ]
};

class NetLobby {
    constructor() {
        this.client = null;
        this.localStream = null;
        this.peers = {}; // id -> { pc, user }
        this.users = {}; // id -> user info (for UI)
        this.myId = 'u_' + Math.random().toString(36).substr(2, 9);
        this.myProfile = { name: 'User', avatar: '' };
        this.audioContext = null;
        this.isMuted = false;
        
        // MQTT Topics
        this.topicPresence = `${ROOM_ID}/presence`;
        this.topicSignal = `${ROOM_ID}/signal/${this.myId}`;
        this.topicChat = `${ROOM_ID}/chat`;
    }

    init() {
        // –ó–∞–≥—Ä—É–∑–∫–∞ –ø—Ä–æ—Ñ–∏–ª—è
        const savedName = localStorage.getItem('nl_name');
        const savedAvatar = localStorage.getItem('nl_avatar');
        if (savedName) document.getElementById('username-input').value = savedName;
        
        // –î–µ—Ñ–æ–ª—Ç–Ω–∞—è –∞–≤–∞—Ç–∞—Ä–∫–∞
        const defaultAvatar = 'data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCAxMDAgMTAwIiBmaWxsPSIjNTg2NUYyIj48Y2lyY2xlIGN4PSI1MCIgY3k9IjUwIiByPSI1MCIvPjwvc3ZnPg==';
        this.myProfile.avatar = savedAvatar || defaultAvatar;
        document.getElementById('avatar-preview').style.backgroundImage = `url(${this.myProfile.avatar})`;

        // –ó–∞–≥—Ä—É–∑–∫–∞ —Ñ–∞–π–ª–∞
        document.getElementById('avatar-upload').addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = (ev) => {
                this.myProfile.avatar = ev.target.result;
                document.getElementById('avatar-preview').style.backgroundImage = `url(${this.myProfile.avatar})`;
            };
            reader.readAsDataURL(file);
        });
    }

    async join() {
        const name = document.getElementById('username-input').value.trim();
        if (!name) return alert("–í–≤–µ–¥–∏—Ç–µ –∏–º—è");
        this.myProfile.name = name;
        localStorage.setItem('nl_name', name);
        localStorage.setItem('nl_avatar', this.myProfile.avatar);

        // –ü–æ–ª—É—á–∞–µ–º –º–∏–∫—Ä–æ—Ñ–æ–Ω
        try {
            this.localStream = await navigator.mediaDevices.getUserMedia({ audio: true, video: false });
            this.setupVAD(this.localStream, 'local');
        } catch (e) {
            console.warn("No Mic:", e);
            alert("–ú–∏–∫—Ä–æ—Ñ–æ–Ω –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω, —Ä–µ–∂–∏–º —Å–ª—É—à–∞—Ç–µ–ª—è.");
        }

        // –ò–Ω—Ç–µ—Ä—Ñ–µ–π—Å
        document.getElementById('login-screen').classList.add('hidden');
        document.getElementById('app-screen').classList.remove('hidden');
        this.connectMQTT();
    }

    // --- MQTT (Signaling) ---

    connectMQTT() {
        document.getElementById('diag-mqtt').textContent = 'Connecting...';
        
        this.client = mqtt.connect(MQTT_BROKER);

        this.client.on('connect', () => {
            document.getElementById('diag-mqtt').textContent = 'Connected';
            document.getElementById('diag-mqtt').style.color = 'lime';
            document.getElementById('connection-status').textContent = '–ü–æ–¥–∫–ª—é—á–µ–Ω–æ';

            // –ü–æ–¥–ø–∏—Å–∫–∏
            this.client.subscribe(this.topicPresence); // –ö—Ç–æ –æ–Ω–ª–∞–π–Ω?
            this.client.subscribe(`${ROOM_ID}/signal/${this.myId}`); // –õ–∏—á–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è –º–Ω–µ
            this.client.subscribe(this.topicChat); // –û–±—â–∏–π —á–∞—Ç

            // –ê–Ω–æ–Ω—Å–∏—Ä—É–µ–º —Å–µ–±—è (Hello message)
            this.announcePresence();
            
            // –ü–æ–≤—Ç–æ—Ä—è–µ–º –∞–Ω–æ–Ω—Å —Ä–∞–∑ –≤ 5 —Å–µ–∫ (heartbeat), —á—Ç–æ–±—ã –Ω–æ–≤—ã–µ —é–∑–µ—Ä—ã –Ω–∞—Å —É–≤–∏–¥–µ–ª–∏
            setInterval(() => this.announcePresence(), 5000);
        });

        this.client.on('message', async (topic, message) => {
            const data = JSON.parse(message.toString());
            
            if (topic === this.topicPresence) {
                this.handlePresence(data);
            } else if (topic === this.topicChat) {
                this.renderMessage(data);
            } else {
                // –õ–∏—á–Ω—ã–π —Å–∏–≥–Ω–∞–ª (SDP/ICE)
                this.handleSignal(data);
            }
        });
    }

    announcePresence() {
        const payload = { 
            type: 'hello', 
            id: this.myId, 
            user: this.myProfile 
        };
        this.client.publish(this.topicPresence, JSON.stringify(payload));
    }

    handlePresence(data) {
        if (data.id === this.myId) return;

        // –ï—Å–ª–∏ –≤–∏–¥–∏–º –Ω–æ–≤–æ–≥–æ —é–∑–µ—Ä–∞, –¥–æ–±–∞–≤–ª—è–µ–º –≤ UI
        if (!this.users[data.id]) {
            this.users[data.id] = data.user;
            this.updateUserList();
            this.addSystemMessage(`${data.user.name} –∑–∞—à–µ–ª –≤ –ª–æ–±–±–∏.`);
            
            // WebRTC Mesh: –¢–æ—Ç, —É –∫–æ–≥–æ ID "–±–æ–ª—å—à–µ" (–ª–µ–∫—Å–∏–∫–æ–≥—Ä–∞—Ñ–∏—á–µ—Å–∫–∏), –∏–Ω–∏—Ü–∏–∏—Ä—É–µ—Ç –∑–≤–æ–Ω–æ–∫.
            // –≠—Ç–æ –ø—Ä–æ—Å—Ç–æ–π —Å–ø–æ—Å–æ–± –∏–∑–±–µ–∂–∞—Ç—å –¥–≤–æ–π–Ω–æ–≥–æ –¥–æ–∑–≤–æ–Ω–∞.
            if (this.myId > data.id) {
                this.createPeer(data.id, true);
            }
        } else {
            // –û–±–Ω–æ–≤–ª—è–µ–º —Ç–∞–π–º—Å—Ç–∞–º–ø "–∂–∏–∑–Ω–∏", –µ—Å–ª–∏ –Ω—É–∂–Ω–æ (—Ç—É—Ç —É–ø—Ä–æ—â–µ–Ω–æ)
        }
    }

    // --- WebRTC ---

    createPeer(targetId, initiator) {
        if (this.peers[targetId]) return; // –£–∂–µ –µ—Å—Ç—å

        const pc = new RTCPeerConnection(ICE_SERVERS);
        
        // –î–æ–±–∞–≤–ª—è–µ–º —Å–≤–æ–π –∑–≤—É–∫
        if (this.localStream) {
            this.localStream.getTracks().forEach(t => pc.addTrack(t, this.localStream));
        }

        // ICE –∫–∞–Ω–¥–∏–¥–∞—Ç—ã -> —à–ª–µ–º —á–µ—Ä–µ–∑ MQTT
        pc.onicecandidate = (e) => {
            if (e.candidate) {
                this.sendSignal(targetId, { type: 'candidate', candidate: e.candidate });
            }
        };

        // –í—Ö–æ–¥—è—â–∏–π –∑–≤—É–∫
        pc.ontrack = (e) => {
            const audio = new Audio();
            audio.srcObject = e.streams[0];
            audio.autoplay = true;
            document.body.appendChild(audio);
            this.setupVAD(e.streams[0], targetId);
        };
        
        // –ß–∏—Å—Ç–∏–º, –µ—Å–ª–∏ –æ—Ç–≤–∞–ª–∏–ª—Å—è
        pc.oniceconnectionstatechange = () => {
            if (pc.iceConnectionState === 'disconnected' || pc.iceConnectionState === 'failed') {
                this.removePeer(targetId);
            }
        };

        this.peers[targetId] = pc;
        document.getElementById('diag-peers').textContent = Object.keys(this.peers).length;

        if (initiator) {
            pc.createOffer().then(offer => {
                pc.setLocalDescription(offer);
                this.sendSignal(targetId, { type: 'sdp', sdp: offer });
            });
        }
    }

    async handleSignal(data) {
        // data = { senderId, payload: { type, sdp/candidate } }
        const peerId = data.senderId;
        const signal = data.payload;

        // –ï—Å–ª–∏ –∑–≤–æ–Ω–∏—Ç –∫—Ç–æ-—Ç–æ –Ω–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π (–º—ã –µ–≥–æ –µ—â–µ –Ω–µ –≤–∏–¥–µ–ª–∏ –≤ presence), —Å–æ–∑–¥–∞–µ–º Peer –∫–∞–∫ –æ—Ç–≤–µ—á–∞—é—â–∏–π
        if (!this.peers[peerId]) {
            this.createPeer(peerId, false);
        }

        const pc = this.peers[peerId];

        if (signal.type === 'sdp') {
            await pc.setRemoteDescription(new RTCSessionDescription(signal.sdp));
            if (signal.sdp.type === 'offer') {
                const answer = await pc.createAnswer();
                await pc.setLocalDescription(answer);
                this.sendSignal(peerId, { type: 'sdp', sdp: answer });
            }
        } else if (signal.type === 'candidate') {
            try { await pc.addIceCandidate(new RTCIceCandidate(signal.candidate)); } catch(e){}
        }
    }

    sendSignal(targetId, payload) {
        // –ü—É–±–ª–∏–∫—É–µ–º –≤ —Ç–æ–ø–∏–∫ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ —é–∑–µ—Ä–∞
        const topic = `${ROOM_ID}/signal/${targetId}`;
        const msg = { senderId: this.myId, payload: payload };
        this.client.publish(topic, JSON.stringify(msg));
    }

    removePeer(id) {
        if (this.peers[id]) {
            this.peers[id].close();
            delete this.peers[id];
            // –ù–µ —É–¥–∞–ª—è–µ–º –∏–∑ —Å–ø–∏—Å–∫–∞ —é–∑–µ—Ä–æ–≤ —Å—Ä–∞–∑—É, –º–æ–∂–µ—Ç –æ–Ω –ø—Ä–æ—Å—Ç–æ –ø–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–∞–µ—Ç—Å—è
            // –ù–æ –¥–ª—è —É–ø—Ä–æ—â–µ–Ω–∏—è –º–æ–∂–Ω–æ —É–¥–∞–ª–∏—Ç—å:
            // delete this.users[id];
            // this.updateUserList();
            document.getElementById('diag-peers').textContent = Object.keys(this.peers).length;
        }
    }

    // --- Chat & UI ---

    sendMessage() {
        const input = document.getElementById('chat-input');
        const text = input.value.trim();
        if(!text) return;
        
        const msg = {
            id: this.myId,
            name: this.myProfile.name,
            avatar: this.myProfile.avatar,
            text: text,
            time: new Date().toLocaleTimeString().slice(0,5)
        };
        this.client.publish(this.topicChat, JSON.stringify(msg));
        input.value = '';
    }

    renderMessage(msg) {
        const list = document.getElementById('messages');
        const div = document.createElement('div');
        div.className = 'message';
        const safeText = msg.text.replace(/</g, "&lt;");
        div.innerHTML = `
            <div class="msg-avatar" style="background-image: url('${msg.avatar}')"></div>
            <div class="msg-content">
                <div class="msg-header">
                    <span class="msg-author">${msg.name}</span>
                    <span class="msg-time">${msg.time}</span>
                </div>
                <div class="msg-text">${safeText}</div>
            </div>`;
        list.appendChild(div);
        list.scrollTop = list.scrollHeight;
    }

    addSystemMessage(text) {
        const list = document.getElementById('messages');
        const div = document.createElement('div');
        div.style.cssText = 'color:#72767d; font-size:0.8em; margin: 5px 0 5px 60px;';
        div.textContent = `> ${text}`;
        list.appendChild(div);
    }

    updateUserList() {
        const list = document.getElementById('user-list');
        list.innerHTML = '';
        
        // –Ø
        this.appendUserUI(this.myProfile, true);
        
        // –û—Å—Ç–∞–ª—å–Ω—ã–µ
        Object.values(this.users).forEach(u => this.appendUserUI(u, false));
    }

    appendUserUI(user, isSelf) {
        const list = document.getElementById('user-list');
        const div = document.createElement('div');
        div.className = 'user-item';
        if(isSelf) div.setAttribute('data-self','true');
        else div.setAttribute('data-id', user.id); // –£–ø—Ä–æ—â–µ–Ω–æ (–≤ user –Ω–µ—Ç id –≤ –æ–±—ä–µ–∫—Ç–µ, –Ω–æ –æ–Ω –µ—Å—Ç—å –≤ key)
        
        div.innerHTML = `
            <div class="user-avatar" style="background-image: url('${user.avatar}')"></div>
            <div class="user-name">${user.name} ${isSelf ? '(–í—ã)' : ''}</div>
        `;
        list.appendChild(div);
    }

    // --- Audio Helpers ---
    setupVAD(stream, id) {
        if (!this.audioContext) this.audioContext = new (window.AudioContext || window.webkitAudioContext)();
        if (this.audioContext.state === 'suspended') this.audioContext.resume();
        const src = this.audioContext.createMediaStreamSource(stream);
        const anl = this.audioContext.createAnalyser();
        anl.fftSize = 256;
        src.connect(anl);
        const data = new Uint8Array(anl.frequencyBinCount);
        
        const loop = () => {
            anl.getByteFrequencyData(data);
            let sum=0; for(let i=0;i<data.length;i++) sum+=data[i];
            const vol = sum/data.length;
            
            // –ù–∞–π—Ç–∏ –∞–≤–∞—Ç–∞—Ä–∫—É
            let sel = id === 'local' ? '[data-self="true"] .user-avatar' : `.user-item .user-avatar`; // –£–ø—Ä–æ—â–µ–Ω–æ
            // –í —Ä–µ–∞–ª—å–Ω–æ–º –∫–æ–¥–µ –Ω—É–∂–Ω–æ —Ç–æ—á–Ω–µ–µ –∏—Å–∫–∞—Ç—å –ø–æ ID, –∑–¥–µ—Å—å –æ–ø—É—Å—Ç–∏–º –¥–ª—è –∫—Ä–∞—Ç–∫–æ—Å—Ç–∏
            
            // –í–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏—è "–≥–æ–≤–æ—Ä–µ–Ω–∏—è" (–∑–µ–ª–µ–Ω–∞—è —Ä–∞–º–∫–∞)
            // ... —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è —Ç–æ—á–Ω–æ–≥–æ –ø–æ–∏—Å–∫–∞ DOM —ç–ª–µ–º–µ–Ω—Ç–∞ ...
            requestAnimationFrame(loop);
        };
        loop();
    }

    toggleMic() {
        if(!this.localStream) return;
        this.isMuted = !this.isMuted;
        this.localStream.getAudioTracks()[0].enabled = !this.isMuted;
        const btn = document.getElementById('mic-btn');
        btn.classList.toggle('muted');
        document.getElementById('connection-status').textContent = this.isMuted ? 'Muted' : 'Connected';
    }
}

const app = new NetLobby();
app.init();
</script>
</body>
</html>
