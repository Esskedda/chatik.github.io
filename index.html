<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>VoiceGrid Lobby</title>
    <script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=gg+sans:wght@400;600;700&display=swap" rel="stylesheet">
    
    <style>
        :root {
            /* Discord-like Palette */
            --bg-dark: #313338;
            --bg-card: #2b2d31;
            --bg-chat: #313338;
            --bg-sidebar: #1e1f22;
            --primary: #5865F2;
            --success: #23a559;
            --danger: #da373c;
            --text-main: #f2f3f5;
            --text-muted: #b5bac1;
            --card-radius: 8px;
        }

        * { box-sizing: border-box; outline: none; -webkit-tap-highlight-color: transparent; }
        
        body, html { 
            margin: 0; padding: 0; height: 100%; 
            font-family: 'gg sans', 'Segoe UI', sans-serif;
            background: var(--bg-dark); color: var(--text-main);
            overflow: hidden;
        }

        /* --- ICONS (SVG) --- */
        .icon { width: 24px; height: 24px; fill: currentColor; }

        /* --- LOGIN SCREEN --- */
        #login-screen {
            display: flex; height: 100vh; align-items: center; justify-content: center;
            background: url('https://cdn.discordapp.com/attachments/100000000000000000/100000000000000000/bg.png') no-repeat center/cover;
            background-color: #1e1f22;
        }
        .login-card {
            background: #313338; padding: 32px; border-radius: 5px;
            width: 100%; max-width: 400px; box-shadow: 0 8px 16px rgba(0,0,0,0.24);
            text-align: center;
        }
        .avatar-upload {
            width: 96px; height: 96px; border-radius: 50%; background-color: #1e1f22;
            margin: 0 auto 20px; background-size: cover; cursor: pointer;
            position: relative; border: 3px solid transparent; transition: 0.2s;
        }
        .avatar-upload:hover { border-color: var(--primary); }
        .avatar-upload::after {
            content: '+'; position: absolute; bottom: 0; right: 0;
            background: var(--success); color: white; width: 28px; height: 28px;
            border-radius: 50%; font-weight: bold; line-height: 28px;
            box-shadow: 0 0 0 3px #313338;
        }

        input.discord-input {
            background: #1e1f22; border: none; padding: 10px; color: white;
            width: 100%; height: 40px; border-radius: 3px; font-size: 16px; margin-bottom: 20px;
        }
        .btn-discord {
            background: var(--primary); color: white; border: none; width: 100%;
            padding: 12px; border-radius: 3px; font-weight: 600; cursor: pointer;
            transition: 0.2s; font-size: 16px;
        }
        .btn-discord:hover { background: #4752c4; }

        /* --- MAIN LAYOUT --- */
        #app-layout {
            display: flex; height: 100vh; width: 100%;
        }

        /* VOICE STAGE (CENTER/LEFT) */
        .stage-area {
            flex: 1; background: #000000; display: flex; flex-direction: column;
            position: relative;
        }
        .stage-header {
            padding: 10px 20px; font-weight: bold; color: white;
            background: rgba(0,0,0,0.3); display: flex; justify-content: space-between;
        }
        .stage-grid {
            flex: 1; padding: 20px; overflow-y: auto;
            display: grid; 
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            grid-auto-rows: 180px; gap: 16px; align-content: start;
        }

        /* USER CARD */
        .voice-card {
            background: #2b2d31; border-radius: 8px;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            position: relative; transition: all 0.2s; cursor: pointer;
            border: 2px solid transparent;
        }
        .voice-card:hover { background: #33353a; }
        
        /* Green border when speaking */
        .voice-card.speaking { border-color: var(--success); box-shadow: 0 0 15px rgba(35, 165, 89, 0.4); }

        .card-avatar {
            width: 80px; height: 80px; border-radius: 50%;
            background-size: cover; background-color: #1e1f22; margin-bottom: 12px;
            position: relative;
        }
        .card-name { font-weight: 600; color: white; font-size: 16px; }
        
        /* Status Icons on Card */
        .card-status {
            position: absolute; bottom: 10px; right: 10px;
            background: rgba(0,0,0,0.6); padding: 4px; border-radius: 4px;
        }
        .status-icon-mic { width: 16px; height: 16px; fill: white; }
        .status-icon-mic.off { fill: var(--danger); }

        /* BOTTOM CONTROLS (Floating) */
        .bottom-controls {
            height: 60px; background: #1e1f22; display: flex; align-items: center;
            justify-content: center; gap: 20px; padding: 0 20px;
        }
        .control-btn {
            width: 48px; height: 48px; border-radius: 50%; border: none;
            background: #313338; color: white; cursor: pointer; display: flex; align-items: center; justify-content: center;
            transition: 0.2s;
        }
        .control-btn:hover { background: #404249; }
        .control-btn.active { background: white; color: black; } /* Mic On style */
        .control-btn.muted { background: var(--danger); color: white; } /* Mic Off style */
        .control-btn.leave { background: #da373c; }

        /* CHAT PANEL (RIGHT) */
        .chat-panel {
            width: 350px; background: var(--bg-chat); border-left: 1px solid #1e1f22;
            display: flex; flex-direction: column;
        }
        .chat-header {
            height: 48px; padding: 0 16px; border-bottom: 1px solid #1e1f22;
            display: flex; align-items: center; font-weight: bold; color: var(--text-muted);
            box-shadow: 0 1px 2px rgba(0,0,0,0.1);
        }
        #messages {
            flex: 1; overflow-y: auto; padding: 20px; display: flex; flex-direction: column; gap: 16px;
        }
        .msg { display: flex; gap: 12px; }
        .msg:hover { background: rgba(0,0,0,0.03); } 
        .msg-ava { width: 40px; height: 40px; border-radius: 50%; background-size: cover; flex-shrink: 0; cursor: pointer; }
        .msg-body { flex: 1; min-width: 0; }
        .msg-top { display: flex; align-items: baseline; gap: 8px; }
        .msg-user { font-weight: 600; color: white; cursor: pointer; }
        .msg-user:hover { text-decoration: underline; }
        .msg-time { font-size: 11px; color: var(--text-muted); }
        .msg-text { color: #dbdee1; font-size: 15px; line-height: 1.4; white-space: pre-wrap; word-break: break-word; }

        .chat-input-area { padding: 20px; background: var(--bg-chat); }
        .chat-input-box {
            background: #383a40; border-radius: 8px; padding: 0 16px;
            display: flex; align-items: center;
        }
        .chat-input {
            width: 100%; border: none; background: transparent; padding: 12px 0;
            color: white; font-size: 15px; height: 44px;
        }
        .send-btn { background: transparent; border: none; color: var(--text-muted); cursor: pointer; }
        .send-btn:hover { color: var(--text-main); }

        /* --- MOBILE RESPONSIVE --- */
        @media (max-width: 768px) {
            #app-layout { flex-direction: column; }
            .stage-area { height: 45vh; flex: none; }
            .stage-grid { 
                grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); 
                grid-auto-rows: 140px; padding: 10px; gap: 10px;
            }
            .voice-card {  }
            .card-avatar { width: 50px; height: 50px; }
            
            .chat-panel { width: 100%; flex: 1; border-left: none; border-top: 1px solid #1e1f22; }
            .bottom-controls { height: 50px; padding: 0 10px; }
            .control-btn { width: 40px; height: 40px; }
        }

        .hidden { display: none !important; }
    </style>
</head>
<body>

    <!-- 1. LOGIN SCREEN -->
    <div id="login-screen">
        <div class="login-card">
            <h2 style="color:white; margin-bottom: 5px;">–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å</h2>
            <p style="color:#b5bac1; margin-bottom: 20px;">–í—Ö–æ–¥ –≤ –≥–æ–ª–æ—Å–æ–≤–æ–π –∫–∞–Ω–∞–ª</p>
            
            <div id="avatar-preview" class="avatar-upload" onclick="document.getElementById('avatar-file').click()"></div>
            <input type="file" id="avatar-file" hidden accept="image/*">
            
            <input type="text" id="username-in" class="discord-input" placeholder="–ö–∞–∫ –≤–∞—Å –∑–æ–≤—É—Ç?">
            <button class="btn-discord" onclick="app.join()">–ü—Ä–∏—Å–æ–µ–¥–∏–Ω–∏—Ç—å—Å—è</button>
        </div>
    </div>

    <!-- 2. APP LAYOUT -->
    <div id="app-layout" class="hidden">
        
        <!-- VOICE AREA (Center/Top) -->
        <div class="stage-area">
            <div class="stage-header">
                <span>üîä –ì–æ–ª–æ—Å–æ–≤–æ–π –∫–∞–Ω–∞–ª</span>
                <span id="connection-status" style="font-size:12px; color:var(--success)">‚óè Connected</span>
            </div>
            
            <div id="grid-users" class="stage-grid">
                <!-- –ö–∞—Ä—Ç–æ—á–∫–∏ –¥–æ–±–∞–≤–ª—è—é—Ç—Å—è —Å—é–¥–∞ JS -->
            </div>

            <div class="bottom-controls">
                <button class="control-btn active" id="btn-mic" onclick="app.toggleMic()">
                    <!-- Mic Icon SVG -->
                    <svg class="icon" viewBox="0 0 24 24"><path d="M12 2a3 3 0 0 0-3 3v7a3 3 0 0 0 6 0V5a3 3 0 0 0-3-3Z"/><path d="M19 10v2a7 7 0 0 1-14 0v-2H3v2a9 9 0 0 0 8 8.88V22h2v-1.12A9 9 0 0 0 21 12v-2h-2Z"/></svg>
                </button>
                <button class="control-btn leave" onclick="app.logout()">
                    <!-- Phone Hangup SVG -->
                    <svg class="icon" viewBox="0 0 24 24"><path d="M11.95 16.5c-3.1 0-6.1-1.5-7.9-3.9a1 1 0 0 1-.05-1.2l2.3-3c.4-.5 1.1-.6 1.6-.3l3.5 2.1c.4.3.7.8.5 1.3l-.9 3.2c.3.1.6.2.95.2s.65-.1.95-.2l-.9-3.2c-.2-.5.1-1 .5-1.3l3.5-2.1c.5-.3 1.2-.2 1.6.3l2.3 3a1 1 0 0 1 0 1.2c-1.8 2.4-4.8 3.9-7.95 3.9Z" fill="white"/></svg>
                </button>
            </div>
        </div>

        <!-- CHAT PANEL (Right/Bottom) -->
        <div class="chat-panel">
            <div class="chat-header"># general-chat</div>
            <div id="messages">
                <!-- –°–æ–æ–±—â–µ–Ω–∏—è -->
            </div>
            <div class="chat-input-area">
                <div class="chat-input-box">
                    <input type="text" id="msg-in" class="chat-input" placeholder="–ù–∞–ø–∏—Å–∞—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ #general">
                    <button class="send-btn" onclick="app.sendText()">‚û§</button>
                </div>
            </div>
        </div>

    </div>

<script>
/* 
   CORE LOGIC - SAME AS BEFORE, JUST UI ADAPTATIONS
*/
const MQTT_BROKER = 'wss://broker.emqx.io:8084/mqtt';
const ROOM_ID = 'discord-clone-grid-v4';
const ICE_SERVERS = {
    iceServers: [ { urls: 'stun:stun.l.google.com:19302' } ] 
};

class App {
    constructor() {
        this.client = null;
        this.localStream = null;
        this.peers = {}; 
        this.users = {}; 
        this.myId = 'u_' + Math.random().toString(36).substr(2, 5);
        this.myProfile = { name: '', avatar: '' };
        this.audioCtx = null;
        this.isMuted = false; // Start Unmuted usually, but let's init
    }

    init() {
        const hasSession = localStorage.getItem('dc_session');
        const savedName = localStorage.getItem('dc_name');
        const savedAva = localStorage.getItem('dc_ava');

        // Default Avatar
        const defAva = 'https://cdn.discordapp.com/embed/avatars/0.png';
        this.myProfile.avatar = savedAva || defAva;
        document.getElementById('avatar-preview').style.backgroundImage = `url(${this.myProfile.avatar})`;

        if (savedName) document.getElementById('username-in').value = savedName;

        // File Input
        document.getElementById('avatar-file').addEventListener('change', e => {
            const f = e.target.files[0];
            if(f) {
                const r = new FileReader();
                r.onload = ev => {
                    this.myProfile.avatar = ev.target.result;
                    document.getElementById('avatar-preview').style.backgroundImage = `url(${ev.target.result})`;
                }
                r.readAsDataURL(f);
            }
        });

        document.getElementById('msg-in').addEventListener('keydown', e => {
            if(e.key==='Enter') this.sendText();
        });

        if(hasSession === 'true' && savedName) {
            this.myProfile.name = savedName;
            this.enterApp();
        }
    }

    async join() {
        const name = document.getElementById('username-in').value.trim();
        if(!name) return alert('–ù—É–∂–Ω–æ –∏–º—è!');
        this.myProfile.name = name;
        
        localStorage.setItem('dc_name', name);
        localStorage.setItem('dc_ava', this.myProfile.avatar);
        localStorage.setItem('dc_session', 'true');
        
        this.enterApp();
    }

    async enterApp() {
        document.getElementById('login-screen').classList.add('hidden');
        document.getElementById('app-layout').classList.remove('hidden');

        // Get Audio
        try {
            this.localStream = await navigator.mediaDevices.getUserMedia({ audio: true });
            this.setupVAD(this.localStream, this.myId);
        } catch(e) {
            console.error(e);
            alert("–ú–∏–∫—Ä–æ—Ñ–æ–Ω –Ω–µ –Ω–∞–π–¥–µ–Ω :(");
        }

        this.connectMQTT();
        this.updateGrid();
    }

    logout() {
        localStorage.removeItem('dc_session');
        location.reload();
    }

    // --- MQTT ---

    connectMQTT() {
        this.client = mqtt.connect(MQTT_BROKER);
        
        this.client.on('connect', () => {
            this.client.subscribe(`${ROOM_ID}/presence`);
            this.client.subscribe(`${ROOM_ID}/chat`);
            this.client.subscribe(`${ROOM_ID}/signal/${this.myId}`);
            
            this.announce();
            setInterval(() => this.announce(), 5000);
        });

        this.client.on('message', (topic, msg) => {
            const d = JSON.parse(msg.toString());
            if(topic.includes('presence')) this.handlePresence(d);
            else if(topic.includes('chat')) this.renderChat(d);
            else this.handleSignal(d);
        });
    }

    announce() {
        // Broadcast my presence + mic status
        this.client.publish(`${ROOM_ID}/presence`, JSON.stringify({
            id: this.myId,
            user: this.myProfile,
            isMuted: this.isMuted
        }));
    }

    handlePresence(data) {
        if(data.id === this.myId) return;
        
        // Update User info
        if(!this.users[data.id]) {
            this.users[data.id] = data.user;
            this.users[data.id].isMuted = data.isMuted; // Track mute state
            this.updateGrid();
            if(this.myId > data.id) this.createPeer(data.id, true);
        } else {
            // Update mutable state (mic status)
            if (this.users[data.id].isMuted !== data.isMuted) {
                this.users[data.id].isMuted = data.isMuted;
                this.updateCardStatus(data.id, data.isMuted);
            }
        }
    }

    // --- WebRTC ---
    
    createPeer(targetId, initiator) {
        if(this.peers[targetId]) return;
        const pc = new RTCPeerConnection(ICE_SERVERS);
        
        if(this.localStream) {
            this.localStream.getTracks().forEach(t => pc.addTrack(t, this.localStream));
        }

        pc.onicecandidate = e => {
            if(e.candidate) this.sendSig(targetId, { type: 'candidate', candidate: e.candidate });
        };

        pc.ontrack = e => {
            const aud = new Audio();
            aud.srcObject = e.streams[0];
            aud.autoplay = true;
            document.body.appendChild(aud); // Invisible audio
            this.setupVAD(e.streams[0], targetId);
        };

        pc.oniceconnectionstatechange = () => {
            if(pc.iceConnectionState === 'disconnected') {
                pc.close(); delete this.peers[targetId]; delete this.users[targetId];
                this.updateGrid();
            }
        }

        this.peers[targetId] = pc;
        
        if(initiator) {
            pc.createOffer().then(o => { pc.setLocalDescription(o); this.sendSig(targetId, {type:'sdp', sdp:o})});
        }
    }

    async handleSignal(data) {
        const { senderId, payload } = data;
        if(!this.peers[senderId]) this.createPeer(senderId, false);
        const pc = this.peers[senderId];

        if(payload.type === 'sdp') {
            await pc.setRemoteDescription(new RTCSessionDescription(payload.sdp));
            if(payload.sdp.type === 'offer') {
                const ans = await pc.createAnswer();
                await pc.setLocalDescription(ans);
                this.sendSig(senderId, {type:'sdp', sdp:ans});
            }
        } else if(payload.type === 'candidate') {
            pc.addIceCandidate(new RTCIceCandidate(payload.candidate)).catch(()=>{});
        }
    }

    sendSig(target, payload) {
        this.client.publish(`${ROOM_ID}/signal/${target}`, JSON.stringify({ senderId: this.myId, payload }));
    }

    // --- UI GRID ---

    updateGrid() {
        const grid = document.getElementById('grid-users');
        grid.innerHTML = '';
        
        // Render Me
        this.renderCard(grid, this.myId, this.myProfile, true, this.isMuted);

        // Render Others
        Object.keys(this.users).forEach(uid => {
            this.renderCard(grid, uid, this.users[uid], false, this.users[uid].isMuted);
        });
    }

    renderCard(container, uid, profile, isMe, isMuted) {
        const el = document.createElement('div');
        el.className = 'voice-card';
        el.setAttribute('data-uid', uid);
        
        // Mic Icon SVG logic
        const micIcon = isMuted 
            ? `<svg class="status-icon-mic off" viewBox="0 0 24 24"><path d="M6.7 5.3a1 1 0 0 0-1.4 1.4l14 14a1 1 0 0 0 1.4-1.4l-14-14Zm1.8 11.2 2.6-2.6A3 3 0 0 1 9 12V5a3 3 0 0 1 5.6-1.3l2.2-2.1a1 1 0 0 0-.2-.1 5 5 0 0 0-8.8 3v5.6ZM19 12a1 1 0 0 0-2 0 5 5 0 0 1-.7 2.6l1.5-1.5A6.9 6.9 0 0 0 19 12Zm-7 7a1 1 0 0 1-1 1 4.9 4.9 0 0 1-4.3-2.6 1 1 0 1 0-1.8.8A6.9 6.9 0 0 0 12 21a1 1 0 0 0 1-1v-1.1h-1V19Z"/></svg>`
            : ''; // Hide icon if speaking normally, or show gray? Discord shows nothing if normal.

        el.innerHTML = `
            <div class="card-avatar" style="background-image: url('${profile.avatar}')">
                <div class="card-status" id="status-${uid}">${micIcon}</div>
            </div>
            <div class="card-name">${profile.name} ${isMe ? '(–í—ã)' : ''}</div>
        `;
        container.appendChild(el);
    }

    updateCardStatus(uid, muted) {
        const el = document.getElementById(`status-${uid}`);
        if(el) {
            el.innerHTML = muted 
             ? `<svg class="status-icon-mic off" viewBox="0 0 24 24"><path d="M6.7 5.3a1 1 0 0 0-1.4 1.4l14 14a1 1 0 0 0 1.4-1.4l-14-14Zm1.8 11.2 2.6-2.6A3 3 0 0 1 9 12V5a3 3 0 0 1 5.6-1.3l2.2-2.1a1 1 0 0 0-.2-.1 5 5 0 0 0-8.8 3v5.6ZM19 12a1 1 0 0 0-2 0 5 5 0 0 1-.7 2.6l1.5-1.5A6.9 6.9 0 0 0 19 12Zm-7 7a1 1 0 0 1-1 1 4.9 4.9 0 0 1-4.3-2.6 1 1 0 1 0-1.8.8A6.9 6.9 0 0 0 12 21a1 1 0 0 0 1-1v-1.1h-1V19Z"/></svg>`
             : '';
        }
    }

    // --- CHAT ---

    sendText() {
        const inp = document.getElementById('msg-in');
        const txt = inp.value.trim();
        if(!txt) return;
        
        const payload = { 
            name: this.myProfile.name, 
            avatar: this.myProfile.avatar, 
            text: txt,
            time: new Date().toLocaleTimeString().slice(0,5)
        };
        this.client.publish(`${ROOM_ID}/chat`, JSON.stringify(payload));
        inp.value = '';
    }

    renderChat(d) {
        const list = document.getElementById('messages');
        const div = document.createElement('div');
        div.className = 'msg';
        
        // Highlight links (Simple regex)
        let txt = d.text.replace(/</g, "&lt;");
        
        div.innerHTML = `
            <div class="msg-ava" style="background-image: url('${d.avatar}')"></div>
            <div class="msg-body">
                <div class="msg-top">
                    <span class="msg-user">${d.name}</span>
                    <span class="msg-time">${d.time}</span>
                </div>
                <div class="msg-text">${txt}</div>
            </div>
        `;
        list.appendChild(div);
        list.scrollTop = list.scrollHeight;
    }

    // --- CONTROLS ---

    toggleMic() {
        if(!this.localStream) return;
        this.isMuted = !this.isMuted;
        this.localStream.getAudioTracks()[0].enabled = !this.isMuted;
        
        const btn = document.getElementById('btn-mic');
        // Change Icon style
        if(this.isMuted) {
            btn.classList.remove('active');
            btn.classList.add('muted');
            // Update my card instantly
            this.updateCardStatus(this.myId, true);
        } else {
            btn.classList.add('active');
            btn.classList.remove('muted');
            this.updateCardStatus(this.myId, false);
        }
        this.announce(); // Notify others
    }

    // --- VAD (Green Borders) ---

    setupVAD(stream, uid) {
        if(!this.audioCtx) this.audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        if(this.audioCtx.state==='suspended') this.audioCtx.resume();
        
        const src = this.audioCtx.createMediaStreamSource(stream);
        const anl = this.audioCtx.createAnalyser();
        anl.fftSize = 128;
        src.connect(anl);
        const data = new Uint8Array(anl.frequencyBinCount);

        const loop = () => {
            anl.getByteFrequencyData(data);
            let sum = 0; for(let i=0; i<data.length; i++) sum+=data[i];
            const avg = sum/data.length;
            
            const card = document.querySelector(`.voice-card[data-uid="${uid}"]`);
            if(card) {
                // Threshold ~ 10-15
                if(avg > 12) card.classList.add('speaking');
                else card.classList.remove('speaking');
            }
            requestAnimationFrame(loop);
        };
        loop();
    }
}

const app = new App();
app.init();
</script>
</body>
</html>
