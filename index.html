<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–û–±—â–∞—è –ö–æ–º–Ω–∞—Ç–∞</title>
    <!-- –ü–æ–¥–∫–ª—é—á–∞–µ–º P2P –±–∏–±–ª–∏–æ—Ç–µ–∫—É -->
    <script src="https://unpkg.com/trystero@0.17.0/dist/trystero-torrent.min.js"></script>
    
    <style>
        body { margin: 0; background: #1a1a1a; color: white; font-family: sans-serif; display: flex; flex-direction: column; height: 100vh; align-items: center; justify-content: center; }
        
        /* –ö–Ω–æ–ø–∫–∞ –≤—Ö–æ–¥–∞ */
        #start-btn { padding: 20px 40px; font-size: 24px; background: #28a745; color: white; border: none; border-radius: 50px; cursor: pointer; box-shadow: 0 0 20px rgba(40, 167, 69, 0.5); }
        #start-screen { position: fixed; inset: 0; background: #1a1a1a; display: flex; align-items: center; justify-content: center; z-index: 10; }
        
        /* –°–µ—Ç–∫–∞ —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤ */
        #grid { display: flex; flex-wrap: wrap; gap: 20px; justify-content: center; width: 100%; padding: 20px; max-width: 800px; }
        
        .user { width: 100px; height: 100px; background: #333; border-radius: 15px; display: flex; flex-direction: column; align-items: center; justify-content: center; position: relative; border: 3px solid transparent; }
        .talking { border-color: #28a745; box-shadow: 0 0 15px #28a745; }
        
        /* –ò–∫–æ–Ω–∫–∞ —é–∑–µ—Ä–∞ */
        .icon { font-size: 40px; }
        .label { margin-top: 5px; font-size: 12px; color: #aaa; }

        /* –ü–∞–Ω–µ–ª—å —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è */
        .controls { margin-top: auto; padding: 20px; display: flex; gap: 20px; }
        .btn { width: 60px; height: 60px; border-radius: 50%; border: none; font-size: 24px; cursor: pointer; display: flex; align-items: center; justify-content: center; }
        .mic-on { background: #444; color: white; }
        .mic-off { background: #dc3545; color: white; }
    </style>
</head>
<body>

    <!-- –≠–ö–†–ê–ù –°–¢–ê–†–¢–ê (–Ω—É–∂–µ–Ω —á—Ç–æ–±—ã –±—Ä–∞—É–∑–µ—Ä —Ä–∞–∑—Ä–µ—à–∏–ª –∑–≤—É–∫) -->
    <div id="start-screen">
        <button id="start-btn" onclick="joinRoom()">üìû –í–û–ô–¢–ò –í –ß–ê–¢</button>
    </div>

    <h3>üü¢ –û–±—â–∞—è –∫–æ–º–Ω–∞—Ç–∞</h3>
    <div id="status" style="color:#777; font-size:12px;">–û–∂–∏–¥–∞–Ω–∏–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è...</div>
    
    <div id="grid">
        <!-- –°—é–¥–∞ –¥–æ–±–∞–≤—è—Ç—Å—è –ª—é–¥–∏ -->
    </div>

    <div class="controls">
        <button id="mic-btn" class="btn mic-on" onclick="toggleMic()">üé§</button>
    </div>

    <script>
        // –ï–î–ò–ù–´–ô ID –î–õ–Ø –í–°–ï–• –í –ú–ò–†–ï
        const ROOM_ID = 'GLOBAL_VOICE_ROOM_RU_V1';
        
        let room, localStream;
        let myId = Math.floor(Math.random() * 1000);

        async function joinRoom() {
            document.getElementById('start-screen').style.display = 'none';
            document.getElementById('status').innerText = '–ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ —Å–µ—Ç–∏...';

            try {
                // 1. –ë–µ—Ä–µ–º –º–∏–∫—Ä–æ—Ñ–æ–Ω
                localStream = await navigator.mediaDevices.getUserMedia({ audio: true });
                
                // 2. –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–µ–±—è
                addUser(myId, true);
                visualize(localStream, myId);

                // 3. –°–æ–µ–¥–∏–Ω—è–µ–º—Å—è —Å P2P —Å–µ—Ç—å—é
                initP2P();
                
            } catch (err) {
                alert("–û—à–∏–±–∫–∞: " + err.message + "\n–ë–µ–∑ –º–∏–∫—Ä–æ—Ñ–æ–Ω–∞ —Ä–∞–±–æ—Ç–∞—Ç—å –Ω–µ –±—É–¥–µ—Ç!");
            }
        }

        function initP2P() {
            // –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –¥–ª—è –†–æ—Å—Å–∏–∏ (STUN)
            const config = { iceServers: [{ urls: 'stun:stun.l.google.com:19302' }, { urls: 'stun:stun.sipnet.ru:3478' }] };
            
            // –ü–æ–¥–∫–ª—é—á–∞–µ–º—Å—è –∫ –æ–¥–Ω–æ–π –∫–æ–º–Ω–∞—Ç–µ
            room = Trystero.joinRoom({ appId: ROOM_ID }, 'main_hall');

            // --- –°–û–ë–´–¢–ò–Ø ---

            // –ö—Ç–æ-—Ç–æ –∑–∞—à–µ–ª
            room.onPeerJoin(peerId => {
                console.log("Joined: " + peerId);
                document.getElementById('status').innerText = '–ö—Ç–æ-—Ç–æ –∑–¥–µ—Å—å –µ—Å—Ç—å!';
                // –°—Ä–∞–∑—É –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º –µ–º—É —Å–≤–æ–π –∞—É–¥–∏–æ –ø–æ—Ç–æ–∫
                if(localStream) room.addStream(localStream, peerId);
            });

            // –ö—Ç–æ-—Ç–æ –≤—ã—à–µ–ª
            room.onPeerLeave(peerId => {
                const el = document.getElementById('u-'+peerId);
                if(el) el.remove();
            });

            // –ü—Ä–∏—à–µ–ª –∑–≤—É–∫ –æ—Ç –∫–æ–≥–æ-—Ç–æ
            room.onPeerStream((stream, peerId) => {
                // –°–æ–∑–¥–∞–µ–º –Ω–µ–≤–∏–¥–∏–º—ã–π –ø–ª–µ–µ—Ä
                const audio = new Audio();
                audio.srcObject = stream;
                audio.autoplay = true;
                audio.playsInline = true;
                document.body.appendChild(audio);

                // –†–∏—Å—É–µ–º –∫–≤–∞–¥—Ä–∞—Ç–∏–∫ —é–∑–µ—Ä–∞
                addUser(peerId, false);
                visualize(stream, peerId);
            });

            // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å–≤–æ–π –ø–æ—Ç–æ–∫ –≤—Å–µ–º, –∫—Ç–æ —É–∂–µ —Ç–∞–º
            if(localStream) room.addStream(localStream);
        }

        // --- –§–£–ù–ö–¶–ò–ò –ò–ù–¢–ï–†–§–ï–ô–°–ê ---

        function addUser(id, isMe) {
            if(document.getElementById('u-'+id)) return;
            
            const grid = document.getElementById('grid');
            const div = document.createElement('div');
            div.className = 'user';
            div.id = 'u-'+id;
            div.innerHTML = `
                <div class="icon">üë§</div>
                <div class="label">${isMe ? '–í–´' : '–ì–æ—Å—Ç—å ' + id.toString().substr(0,4)}</div>
            `;
            grid.appendChild(div);
        }

        function toggleMic() {
            if(!localStream) return;
            const track = localStream.getAudioTracks()[0];
            track.enabled = !track.enabled;
            
            const btn = document.getElementById('mic-btn');
            if(track.enabled) {
                btn.className = 'btn mic-on';
                btn.innerText = 'üé§';
            } else {
                btn.className = 'btn mic-off';
                btn.innerText = 'üîá';
            }
        }

        // –ú–∏–≥–∞–Ω–∏–µ –∑–µ–ª–µ–Ω–æ–π —Ä–∞–º–∫–æ–π –∫–æ–≥–¥–∞ –≥–æ–≤–æ—Ä—è—Ç
        function visualize(stream, id) {
            const ctx = new AudioContext();
            const src = ctx.createMediaStreamSource(stream);
            const analyzer = ctx.createAnalyser();
            analyzer.fftSize = 32;
            src.connect(analyzer);
            
            const data = new Uint8Array(analyzer.frequencyBinCount);
            
            setInterval(() => {
                const el = document.getElementById('u-'+id);
                if(!el) return;
                
                analyzer.getByteFrequencyData(data);
                const vol = data.reduce((a,b)=>a+b) / data.length;
                
                if(vol > 10) el.classList.add('talking');
                else el.classList.remove('talking');
            }, 100);
        }
    </script>
</body>
</html>
